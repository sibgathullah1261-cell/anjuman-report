<!DOCTYPE html>
<html lang="en" class=""><head><script>window.livecodes = window.livecodes || {};</script><title>Untitled Project</title><meta name="title" content="Untitled Project"><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"><style id="__livecodes_styles__"></style><script src="https://cdn.jsdelivr.net/npm/es-module-shims@1.10.0/dist/es-module-shims.js" async=""></script><script type="importmap">{
  "imports": {}
}</script></head><body>


  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Program &amp; Treasure Info - U1 to U7</title>
  <style>
    /* =========================================
       1. Base Styles
       ========================================= */
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Segoe UI", Arial, sans-serif; }
    body { background: #f0f2f5; color: #333; line-height: 1.6; padding-bottom: 50px; }
   
    .container {
      max-width: 950px; margin: 30px auto; background: transparent; padding: 0;
    }
    h1, h2, h3 { text-align: center; margin-bottom: 20px; color: #2c3e50; }

    /* Feedback Boxes */
    .error_box, .success_box {
      display: none; padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; font-size: 0.95rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .error_box { background: #ffe6e6; color: #c0392b; border-left: 5px solid #c0392b; }
    .success_box { background: #e6fffa; color: #2c7a7b; border-left: 5px solid #2c7a7b; }

    /* =========================================
       2. Navigation
       ========================================= */
    .navbar {
      background-color: #2c3e50; padding: 15px 0; position: sticky; top: 0; z-index: 100;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .nav-container {
      max-width: 950px; margin: auto; padding: 0 20px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .nav-brand { color: #fff; font-weight: bold; font-size: 1.3rem; text-decoration: none; letter-spacing: 0.5px; }
    .nav-user-info { color: #ecf0f1; font-size: 0.95rem; display: flex; align-items: center; gap: 15px; }
    .btn-logout { background: #e74c3c; color: white; border: none; padding: 6px 15px; border-radius: 4px; cursor: pointer; transition: 0.3s; }
    .btn-logout:hover { background: #c0392b; }

    /* =========================================
       3. Login Screen
       ========================================= */
    .login-card {
      background: white; max-width: 500px; margin: 60px auto; padding: 40px;
      text-align: center; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.05);
    }
    .login-tabs { display: flex; flex-wrap: wrap; margin-bottom: 25px; border-bottom: 2px solid #eee; }
    .login-tab-btn {
      flex:1; padding: 15px; border: none; background: none; font-size: 0.85rem; font-weight: 600;
      color: #95a5a6; cursor: pointer; transition: 0.3s;
    }
    .login-tab-btn.active { color: #3498db; border-bottom: 3px solid #3498db; }
    .login-input-group { margin-bottom: 15px; text-align: left; }
    .login-input-group label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem; color: #555; }
    .login-input-group input, .login-input-group select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size:1rem; }

    /* =========================================
       4. PREMIUM FORM STYLES
       ========================================= */
    .form-wrapper {
      background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    }

    .form-section {
      background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 25px;
      margin-bottom: 25px; position: relative;
    }
    .form-section-title {
      font-size: 1.1rem; font-weight: 700; color: #34495e; margin-bottom: 20px;
      padding-bottom: 10px; border-bottom: 2px solid #e0e0e0; display: flex; align-items: center; gap: 10px;
    }
    .section-icon { color: #3498db; }

    /* Grid Layouts */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
   
    label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: #555; }
    input, select, textarea {
      width: 100%; padding: 12px 15px; border: 1px solid #ced4da; border-radius: 6px;
      font-size: 1rem; transition: all 0.3s ease; background: #fff;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #3498db; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); outline: none;
    }
    textarea { resize: vertical; min-height: 120px; }

    input:disabled, select:disabled { background: #e9ecef; color: #7f8c8d; cursor: not-allowed; font-weight: 500; }

    button.main-btn {
      width: 100%; padding: 16px; background: linear-gradient(135deg, #3498db, #2980b9); color: #fff;
      border: none; border-radius: 8px; font-size: 1.2rem; font-weight: 600; cursor: pointer;
      box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3); transition: transform 0.2s, box-shadow 0.2s;
    }
    /* Treasure Theme Button */
    .btn-treasure {
      width: 100%; padding: 16px; background: linear-gradient(135deg, #f1c40f, #f39c12); color: #fff;
      border: none; border-radius: 8px; font-size: 1.2rem; font-weight: 600; cursor: pointer;
      box-shadow: 0 5px 15px rgba(241, 196, 15, 0.3); transition: transform 0.2s, box-shadow 0.2s;
    }
    /* Core Theme Button */
    .btn-core {
      width: 100%; padding: 16px; background: linear-gradient(135deg, #8e44ad, #703688); color: #fff;
      border: none; border-radius: 8px; font-size: 1.2rem; font-weight: 600; cursor: pointer;
      box-shadow: 0 5px 15px rgba(142, 68, 173, 0.3); transition: transform 0.2s, box-shadow 0.2s;
    }
    
    button.main-btn:hover, .btn-treasure:hover, .btn-core:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4); }
    button.main-btn:active, .btn-treasure:active, .btn-core:active { transform: translateY(0); }
    button.main-btn:disabled, .btn-treasure:disabled, .btn-core:disabled { background: #bdc3c7; cursor: not-allowed; transform: none; box-shadow: none; }

    /* Fieldset Styling for Holders */
    fieldset {
      border: 1px solid #ddd; background: #fff; padding: 20px; border-radius: 6px;
    }
    legend {
      font-weight: bold; color: #2c3e50; padding: 0 10px; font-size: 1rem;
    }
    .form-row { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
    .form-col { flex: 1; min-width: 200px; }

    @media (max-width: 768px) {
      .grid-2, .grid-3 { grid-template-columns: 1fr; }
      .form-row { flex-direction: column; gap: 10px; }
      .form-col { min-width: 100%; }
    }

    /* =========================================
       5. Admin Dashboard Styles
       ========================================= */
    .admin-tabs { display: flex; border-bottom: 2px solid #eee; margin-bottom: 20px; }
    .admin-tab-btn {
      flex:1; padding: 10px; background: none; border: none; font-size: 0.85rem; font-weight: 600;
      color: #7f8c8d; cursor: pointer; border-bottom: 3px solid transparent;
    }
    .admin-tab-btn:hover { color: #3498db; }
    .admin-tab-btn.active { color: #3498db; border-bottom-color: #3498db; }

    /* Settings Styles */
    .settings-form { background: #e8f4fd; padding: 20px; border-radius: 8px; border: 1px solid #d4edda; margin-bottom: 20px; }
    .setting-section { margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #cce5ff; }
    .setting-section h3 { color: #004085; font-size: 1rem; margin-bottom: 15px; }
    .setting-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; align-items: end; }
    .btn-update { background: #004085; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; }

    .mini-form { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 25px; border: 1px solid #e9ecef; }
    .mini-form-row { display: flex; gap: 10px; flex-wrap: wrap; }
    .mini-form-row input, .mini-form-row select { flex: 1; }
    .mini-form-row button { padding: 0 20px; background: #27ae60; border: none; color: white; border-radius: 6px; cursor: pointer; min-width: 100px; }

    /* Tables */
    .table-responsive { overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
    th { background-color: #f1f2f6; font-weight: 600; color: #2c3e50; }
    .btn-view { background-color: #27ae60; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem; margin-right: 5px; }
    .btn-delete { background-color: #e74c3c; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem; }

    /* Category Badge */
    .cat-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
      background-color: #e0e0e0;
      color: #333;
      margin-top: 4px;
    }

    /* Treasure/Bill Specific Styling */
    .amount-highlight { color: #d35400; font-weight: bold; font-size: 1.05rem; }
    .total-treasure-box {
      background: linear-gradient(135deg, #f1c40f, #e67e22);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      margin-bottom: 25px;
      box-shadow: 0 4px 10px rgba(241, 196, 15, 0.2);
    }
    .total-treasure-box h3 { font-size: 2rem; margin: 0 0 5px 0; }

    /* =========================================
       6. TREASURY OVERVIEW STYLES (NEW)
       ========================================= */
    .treasury-overview-section {
      margin-bottom: 30px;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      border-top: 4px solid #f1c40f;
    }

    .overview-title {
      text-align: center;
      margin-bottom: 20px;
      border-bottom: 2px solid #eee;
      padding-bottom: 10px;
    }
    .last-updated {
      font-size: 0.75rem;
      color: #7f8c8d;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .treasury-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    /* Treasury Stat Cards */
    .t-stat-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      text-align: center;
      border-top: 4px solid #bdc3c7;
      transition: transform 0.2s;
    }
    .t-stat-card:hover { transform: translateY(-5px); }

    .ts-label { font-size: 0.85rem; color: #7f8c8d; text-transform: uppercase; font-weight: bold; }
    .ts-value { font-size: 1.5rem; font-weight: bold; color: #2c3e50; }

    /* Specific Card Colors */
    .t-stat-card.gold-total {
      background: linear-gradient(135deg, #f1c40f, #e67e22);
      border: none;
      box-shadow: 0 5px 15px rgba(241, 196, 15, 0.3);
    }
    .t-stat-card.gold-total .ts-label { color: #f39c12; font-weight: bold; opacity: 0.9; }
    .t-stat-card.gold-total .ts-value { color: white; font-size: 2rem; font-weight: 800; }

    .t-stat-card.blue-pending { border-color: #3498db; }
    .t-stat-card.blue-pending .ts-label { color: #3498db; }
    .t-stat-card.blue-pending .ts-value { color: #2c3e50; }

    .t-stat-card.green-approved { border-color: #27ae60; }
    .t-stat-card.green-approved .ts-label { color: #27ae60; }
    .t-stat-card.green-approved .ts-value { color: #2c3e50; }

    .t-stat-card.red-rejected { border-color: #c0392b; }
    .t-stat-card.red-rejected .ts-label { color: #c0392b; }
    .t-stat-card.red-rejected .ts-value { color: #2c3e50; }

    /* Direct Entry Section */
    .direct-entry-section {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 25px;
      border: 1px dashed #ccc;
      margin-bottom: 20px;
    }

    /* =========================================
       7. TREASURY COMMITTEE SPECIFIC STYLES
       ========================================= */
    .treasury-header {
      background: #2c3e50;
      color: #f1c40f;
      padding: 20px;
      border-radius: 10px 10px 0 0;
      text-align: center;
      border-bottom: 4px solid #f1c40f;
    }

    /* Official Ledger Table */
    .ledger-table th { background-color: #2c3e50; color: white; }
    .ledger-table tr:hover { background-color: #f9f9f9; }

    /* Status Badges for Bills */
    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: bold;
      text-transform: uppercase;
    }
    .status-pending { background-color: #fff3cd; color: #856404; }
    .status-approved { background-color: #d4edda; color: #155724; }
    .status-rejected { background-color: #f8d7da; color: #721c24; }

    /* Approval Buttons */
    .btn-approve { background-color: #27ae60; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; }
    .btn-approve:hover { background-color: #219150; }
    .btn-reject { background-color: #c0392b; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; }
    .btn-reject:hover { background-color: #a93226; }

    /* Deleted Item Styling */
    .deleted-row {
      text-decoration: line-through;
      color: #bdc3c7;
      font-style: italic;
      background-color: #f9f9f9;
    }

    /* Stats Cards Styles */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      text-align: center;
      transition: transform 0.2s;
      border-left: 4px solid #3498db;
    }
    .stat-card:hover { transform: translateY(-5px); }
    .stat-card.total {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      border-left: none;
    }
    .stat-card h3, .stat-card h4 { margin: 0 0 10px 0; font-size: 1rem; opacity: 0.9; }
    .stat-card.total h3 { opacity: 1; font-size: 1.2rem; }
    .stat-value { font-size: 2.2rem; font-weight: bold; display: block; }
    .stat-card.total .stat-value { color: white; }
    .stat-card:not(.total) .stat-value { color: #2c3e50; }

    /* Leaderboard Styles */
    .rank-1 { color: #f1c40f; font-weight: bold; font-size: 1.1rem; }
    .rank-2 { color: #95a5a6; font-weight: bold; font-size: 1.1rem; }
    .rank-3 { color: #e67e22; font-weight: bold; font-size: 1.1rem; }

    /* Modal & Toast */
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; }
    .modal.active { opacity: 1; visibility: visible; }
    .modal-content { background: #fff; width: 90%; max-width: 700px; padding: 30px; border-radius: 10px; position: relative; max-height: 90vh; overflow-y: auto; }
    .modal-close { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; background: none; border: none; color: #999; }
    .modal-close:hover { color: #333; }
   
    #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; }
    .toast { background: #333; color: #fff; padding: 12px 20px; border-radius: 5px; margin-top: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); animation: slideIn 0.3s; }
    @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    .hidden { display: none !important; }
  </style>



  <!-- Navbar -->
  <nav class="navbar hidden" id="main-nav">
    <div class="nav-container">
      <a href="#" class="nav-brand" id="nav-brand-text">Program &amp; Treasure</a>
      <div class="nav-user-info">
        <span id="user-display-name">Guest</span>
        <button class="btn-logout" onclick="handleLogout()">Logout</button>
      </div>
    </div>
  </nav>

  <!-- VIEW 1: Login Screen -->
  <div id="view-login" class="container">
    <div class="login-card">
      <h1>Welcome</h1>
      <div class="login-tabs">
        <button class="login-tab-btn active" onclick="toggleLoginTab('wing')">Wing Login</button>
        <button class="login-tab-btn" onclick="toggleLoginTab('admin')">Admin Login</button>
        <button class="login-tab-btn" onclick="toggleLoginTab('treasury')">Treasury Committee</button>
        <button class="login-tab-btn" onclick="toggleLoginTab('core')">Core Committee</button>
      </div>

      <form id="wing-login-form">
        <div class="login-input-group">
          <label>Select Wing</label>
          <select id="login-wing-select" required="">
            <option value="" disabled="" selected="">Select your Wing...</option>
          </select>
        </div>
        <div class="login-input-group">
          <label>Username</label>
          <input type="text" id="login-wing-user" placeholder="Enter username" required="">
        </div>
        <div class="login-input-group">
          <label>Password</label>
          <input type="password" id="login-wing-pass" placeholder="Enter password" required="">
        </div>
        <button type="submit" class="main-btn">Login as Wing Member</button>
      </form>

      <form id="admin-login-form" class="hidden">
        <p style="margin-bottom: 15px; color: #7f8c8d;">Restricted Access</p>
        <div class="login-input-group">
          <label>Admin Password</label>
          <input type="password" id="admin-master-pass" placeholder="Enter Master Password" required="">
        </div>
        <button type="submit" class="main-btn" style="background: linear-gradient(135deg, #2c3e50, #34495e);">Login as Admin</button>
      </form>

      <form id="treasury-login-form" class="hidden">
        <p style="margin-bottom: 15px; color: #f39c12;">Official Treasury Access</p>
        <div class="login-input-group">
          <label>Username</label>
          <input type="text" id="treasury-user" placeholder="Treasury ID" required="">
        </div>
        <div class="login-input-group">
          <label>Password</label>
          <input type="password" id="treasury-pass" placeholder="Treasury Password" required="">
        </div>
        <button type="submit" class="main-btn" style="background: linear-gradient(135deg, #f1c40f, #d35400);">Login as Treasury Secretary</button>
      </form>

      <form id="core-login-form" class="hidden">
        <p style="margin-bottom: 15px; color: #7f8c8d;">Restricted Access</p>
        <div class="login-input-group">
          <label>Username</label>
          <input type="text" id="core-login-user" placeholder="Core Username" required="">
        </div>
        <div class="login-input-group">
          <label>Password</label>
          <input type="password" id="core-login-pass" placeholder="Core Password" required="">
        </div>
        <button type="submit" class="main-btn" style="background: linear-gradient(135deg, #8e44ad, #703688);">Login as Core</button>
      </form>
    </div>
  </div>

  <!-- VIEW 2: Wing Dashboard -->
  <div id="view-wing-dashboard" class="container hidden">
    <h1 id="wing-dash-title">Wing Portal</h1>
    
    <div class="admin-tabs">
      <button class="admin-tab-btn active" onclick="switchWingTab('program')">Submit Program</button>
      <button class="admin-tab-btn" onclick="switchWingTab('treasure')">Submit Treasure (Bill)</button>
    </div>

    <!-- Wing Tab: Submit Program -->
    <div id="wing-tab-program" class="tab-content">
      <div class="error_box" id="form-error"></div>
      <div class="success_box" id="form-success"></div>

      <form action="https://sheetdb.io/api/v1/yqs1gvngfhnfs" method="post" id="sheetdb-form" enctype="multipart/form-data" class="form-wrapper">
        <div class="form-section">
          <div class="form-section-title"><span class="section-icon">üìÖ</span> Program Overview</div>
          <div class="error">Yes......</div>
          <div>
            <label for="Pro_Date">Program Date</label>
            <input type="date" name="data[Date]" id="Pro_Date" required="">
          </div>

          <div style="margin-top: 20px;">
            <label for="Wing">Submitting Wing</label>
            <select name="data[Wing Name]" id="Wing" disabled="" required="">
              <option value="">Select...</option>
            </select>
          </div>

          <div style="margin-top: 15px;">
            <label for="Pro_Category">Program Category</label>
            <select name="data[Category]" id="Pro_Category" required="" onchange="updateHolderDropdowns()">
              <option value="" disabled="" selected="">Select Category...</option>
              <option value="Arts individuals">Arts individuals</option>
              <option value="Arts group">Arts group</option>
              <option value="Sport individuals">Sport individuals</option>
              <option value="Sport group">Sport group</option>
            </select>
          </div>

          <div style="margin-top: 15px;">
            <label for="Pro_Name">Program Name</label>
            <input type="text" name="data[Pragrame Name]" id="Pro_Name" placeholder="e.g. Annual Science Fair" required="">
          </div>
        </div>

        <div class="form-section">
          <div class="form-section-title"><span class="section-icon">üìù</span> Program Details</div>

          <div style="margin-bottom: 15px;">
            <label for="Poster">Program Poster</label>
            <input type="file" name="data[Poster]" id="Poster">
          </div>

          <div style="margin-bottom: 15px;">
            <label for="Pro_Dic">Program Description</label>
            <textarea name="data[Programe Discription]" id="Pro_Dic" placeholder="Describe activities..." required=""></textarea>
          </div>

          <div>
            <label for="Pro_Outcome">Outcomes</label>
            <textarea name="data[Outcomes]" id="Pro_Outcome" placeholder="What were the results or key takeaways..." required=""></textarea>
          </div>
        </div>

        <div class="form-section">
          <div class="form-section-title"><span class="section-icon">üë•</span> Key Participants</div>
         
          <fieldset>
            <legend>Program Holders</legend>
            <!-- FIRST HOLDER -->
            <div class="form-row">
              <div class="form-col">
                <label>First Holder Class</label>
                <select id="h1_class" name="data[First Holder Class]" onchange="loadStudents(this.value,'list1')">
                  <option value="" disabled="" selected="">Select Class</option>
                  <option value="U7">Class U7</option>
                  <option value="U6">Class U6</option>
                  <option value="U5">Class U5</option>
                  <option value="U4">Class U4</option>
                  <option value="U3">Class U3</option>
                  <option value="U2">Class U2</option>
                  <option value="U1">Class U1</option>
                </select>
              </div>
              <div class="form-col">
                <label>First Holder Name</label>
                <input type="text" name="data[First Holder]" id="firstHolder" list="list1" oninput="checkStudentStatus(this)">
                <datalist id="list1"></datalist>
              </div>
            </div>
            <!-- SECOND HOLDER -->
            <div class="form-row">
              <div class="form-col">
                <label>Second Holder Class</label>
                <select id="h2_class" name="data[Second Holder Class]" onchange="loadStudents(this.value,'list2')">
                  <option value="" disabled="" selected="">Select Class</option>
                  <option value="U7">Class U7</option>
                  <option value="U6">Class U6</option>
                  <option value="U5">Class U5</option>
                  <option value="U4">Class U4</option>
                  <option value="U3">Class U3</option>
                  <option value="U2">Class U2</option>
                  <option value="U1">Class U1</option>
                </select>
              </div>
              <div class="form-col">
                <label>Second Holder Name</label>
                <input type="text" name="data[Second Holder]" id="secondHolder" list="list2" oninput="checkStudentStatus(this)">
                <datalist id="list2"></datalist>
              </div>
            </div>
            <!-- THIRD HOLDER -->
            <div class="form-row">
              <div class="form-col">
                <label>Third Holder Class</label>
                <select id="h3_class" name="data[Third Holder Class]" onchange="loadStudents(this.value,'list3')">
                  <option value="" disabled="" selected="">Select Class</option>
                  <option value="U7">Class U7</option>
                  <option value="U6">Class U6</option>
                  <option value="U5">Class U5</option>
                  <option value="U4">Class U4</option>
                  <option value="U3">Class U3</option>
                  <option value="U2">Class U2</option>
                  <option value="U1">Class U1</option>
                </select>
              </div>
              <div class="form-col">
                <label>Third Holder Name</label>
                <input type="text" name="data[Third Holder]" id="thirdHolder" list="list3" oninput="checkStudentStatus(this)">
                <datalist id="list3"></datalist>
              </div>
            </div>
          </fieldset>
        </div>

        <button type="submit" id="submit-btn" class="main-btn">Save Report</button>
      </form>
    </div>

    <!-- Wing Tab: Submit Treasure -->
    <div id="wing-tab-treasure" class="tab-content hidden">
      <div class="error_box" id="bill-error"></div>
      <div class="success_box" id="bill-success"></div>

      <form action="https://sheetdb.io/api/v1/yqs1gvngfhnfs" method="post" id="treasure-form" enctype="multipart/form-data" class="form-wrapper">
        <div class="form-section">
          <div class="form-section-title"><span class="section-icon">üí∞</span> Treasure Bill Details</div>
         
          <div class="grid-2">
             <div>
              <label for="Bill_Date">Bill Date</label>
              <input type="date" name="data[Bill_Date]" id="Bill_Date" required="">
            </div>

            <div>
              <label for="Bill_Amount">Amount (‚Çπ)</label>
              <input type="number" name="data[Bill_Amount]" id="Bill_Amount" placeholder="e.g. 5000" required="" min="1">
            </div>
          </div>

          <div style="margin-top: 20px;">
            <label for="Bill_Wing">Wing Name</label>
            <select name="data[Bill_Wing]" id="Bill_Wing" disabled="" required="">
              <option value="">Select...</option>
            </select>
          </div>

          <div style="margin-top: 15px;">
            <label for="Bill_Category">Category</label>
            <select name="data[Bill_Category]" id="Bill_Category" required="">
              <option value="" disabled="" selected="">Select Category...</option>
              <option value="Decoration">Decoration</option>
              <option value="Food">Food &amp; Refreshments</option>
              <option value="Transport">Transport</option>
              <option value="Prizes">Prizes / Gifts</option>
              <option value="Material">Study Material / stationary</option>
              <option value="Misc">Miscellaneous</option>
            </select>
          </div>
        </div>

        <div class="form-section">
          <div class="form-section-title"><span class="section-icon">üìù</span> Description &amp; Receipt</div>

          <div style="margin-bottom: 15px;">
            <label for="Bill_Subject">Subject / Bill Title</label>
            <input type="text" name="data[Bill_Subject]" id="Bill_Subject" placeholder="e.g. Decoration for Annual Day" required="">
          </div>

          <div style="margin-bottom: 15px;">
            <label for="Bill_Desc">Description</label>
            <textarea name="data[Bill_Desc]" id="Bill_Desc" placeholder="Details of the expense..." required=""></textarea>
          </div>

          <div style="margin-bottom: 15px;">
            <label for="Bill_Receipt">Upload Bill Receipt (Image/PDF)</label>
            <input type="file" name="data[Bill_Receipt]" id="Bill_Receipt" accept="image/*,.pdf">
            <small style="color: #7f8c8d;">Supported: JPG, PNG, PDF (Max 5MB)</small>
          </div>
        </div>

        <button type="submit" id="submit-bill-btn" class="btn-treasure">Submit Bill for Approval</button>
      </form>
    </div>
  </div>

  <!-- VIEW 3: Admin Dashboard -->
  <div id="view-dashboard" class="container hidden">
    <h1>Admin Dashboard</h1>
    <div class="admin-tabs">
      <button class="admin-tab-btn active" onclick="switchAdminTab('reports')">Program Reports</button>
      <button class="admin-tab-btn" onclick="switchAdminTab('clubs')">Manage Wings</button>
      <button class="admin-tab-btn" onclick="switchAdminTab('users')">Manage Users</button>
      <button class="admin-tab-btn" onclick="switchAdminTab('leaderboard')">Student Lboard</button>
      <button class="admin-tab-btn" onclick="switchAdminTab('class-leaderboard')">Class Lboard (Groups)</button>
      <button class="admin-tab-btn" onclick="switchAdminTab('treasure')">Treasure Reports</button>
      <button class="admin-tab-btn" onclick="switchAdminTab('settings')">System Settings</button>
    </div>

    <!-- Tab: Program Reports -->
    <div id="adm-tab-reports" class="tab-content">
      <div id="stats-container" class="stats-grid"></div>
      <div class="table-responsive">
        <table id="report-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Program</th>
              <th>Category</th>
              <th>Wing</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="report-tbody"></tbody>
        </table>
      </div>
      <div id="report-empty" class="empty-state hidden">No reports found.</div>
    </div>

    <!-- Tab: Clubs -->
    <div id="adm-tab-clubs" class="tab-content hidden">
      <div class="mini-form">
        <h3>Add New Wing with Credentials</h3>
        <form id="add-club-form">
          <div class="mini-form-row">
            <input type="text" id="new-club-name" placeholder="Wing Name" required="">
            <input type="text" id="new-club-user" placeholder="Username" required="">
            <input type="text" id="new-club-pass" placeholder="Password" required="">
            <button type="submit">Add Wing</button>
          </div>
        </form>
      </div>
      <div class="table-responsive">
        <table>
          <thead>
            <tr>
              <th>Wing Name</th>
              <th>Username</th>
              <th>Password</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="club-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- Tab: Users -->
    <div id="adm-tab-users" class="tab-content hidden">
      <div class="mini-form">
        <h3>Add New User (Student)</h3>
        <form id="add-user-form">
          <div class="mini-form-row">
            <input type="text" id="new-user-name" placeholder="Student Name" required="">
            <button type="submit">Add User</button>
          </div>
        </form>
      </div>
      <div class="table-responsive">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="user-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- Tab: Student Leaderboard -->
    <div id="adm-tab-leaderboard" class="tab-content hidden">
      <div class="table-responsive">
        <table id="student-leaderboard-table">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Student Name</th>
              <th>Total Points</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="student-leaderboard-tbody"></tbody>
        </table>
      </div>
      <div id="student-leaderboard-empty" class="empty-state hidden">No participant data found.</div>
    </div>

    <!-- Tab: Class Leaderboard -->
    <div id="adm-tab-class-leaderboard" class="tab-content hidden">
      <div style="background:#e8f4fd; color:#004085; padding:15px; border-radius:8px; margin-bottom:20px; text-align:center;">
        <strong>Note:</strong> In this leaderboard, <strong>1st=50, 2nd=40, 3rd=30</strong> points for Group categories.
      </div>
      <div class="table-responsive">
        <table id="class-leaderboard-table">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Class / Group Name</th>
              <th>Total Points</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="class-leaderboard-tbody"></tbody>
        </table>
      </div>
      <div id="class-leaderboard-empty" class="empty-state hidden">No class data found.</div>
    </div>

    <!-- Tab: Treasure Reports -->
    <div id="adm-tab-treasure" class="tab-content hidden">
      <div class="total-treasure-box">
        <h3>Total Approved Expenditure</h3>
        <h2 id="grand-total-display">‚Çπ 0</h2>
      </div>
      
      <div class="table-responsive">
        <table id="treasure-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Wing</th>
              <th>Subject</th>
              <th>Category</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="treasure-tbody"></tbody>
        </table>
      </div>
      <div id="treasure-empty" class="empty-state hidden">No bills found.</div>
    </div>

    <!-- Tab: System Settings (NEW) -->
    <div id="adm-tab-settings" class="tab-content hidden">
      <div class="settings-form">
        <div class="setting-section">
            <h3><span style="color: #004085;">üîí</span> Security Configuration</h3>
            <p style="color: #555; font-size: 0.9rem;">Manage access credentials for committees. Changes apply immediately.</p>
            
            <div class="setting-row">
                <label for="settings-admin-pass">Admin Password</label>
                <input type="text" id="settings-admin-pass" placeholder="Current: admin123">
                <button type="button" onclick="saveSettings()" class="btn-update">Update</button>
            </div>
            <div style="border-top: 1px dashed #ccc; margin: 15px 0;"></div>
            
            <div class="setting-row">
                <label for="settings-core-pass">Core Committee Password</label>
                <input type="text" id="settings-core-pass" placeholder="Current: core123">
                <button type="button" onclick="saveSettings()" class="btn-update">Update</button>
            </div>
            <div style="border-top: 1px dashed #ccc; margin: 15px 0;"></div>

            <div class="setting-row">
                <label for="settings-treasury-user">Treasury Username</label>
                <input type="text" id="settings-treasury-user" placeholder="Current: treasurer">
                <button type="button" onclick="saveSettings()" class="btn-update">Update</button>
            </div>
            <div class="setting-row">
                <label for="settings-treasury-pass">Treasury Password</label>
                <input type="text" id="settings-treasury-pass" placeholder="Current: treasure123">
                <button type="button" onclick="saveSettings()" class="btn-update">Update</button>
            </div>
        </div>
      </div>
    </div>

  </div>

  <!-- VIEW 4: Treasury Committee Dashboard (OVERHAULED) -->
  <div id="view-treasury-dashboard" class="container hidden">
    <div class="treasury-header">
      <h2>Official Treasury Committee</h2>
      <p>Secretary Dashboard: Overview &amp; Audit</p>
    </div>

    <!-- TREASURY OVERVIEW SECTION -->
    <div class="treasury-overview-section">
        <div class="overview-title">
            <h2>Treasury Overview</h2>
            <div class="last-updated">Live Data</div>
        </div>
        
        <div class="treasury-stats-grid">
            <!-- Grand Total -->
            <div class="t-stat-card gold-total">
                <div class="ts-label">Grand Total Approved</div>
                <div class="ts-value" id="sec-grand-total">‚Çπ 0</div>
            </div>
            <!-- Pending Count -->
            <div class="t-stat-card blue-pending">
                <div class="ts-label">Pending Requests</div>
                <div class="ts-value" id="sec-pending-count">0</div>
            </div>
            <!-- Pending Amount -->
            <div class="t-stat-card blue-pending">
                <div class="ts-label">Pending Amount</div>
                <div class="ts-value" id="sec-pending-total">‚Çπ 0</div>
            </div>
            <!-- Rejected Amount -->
            <div class="t-stat-card red-rejected">
                <div class="ts-label">Rejected Amount</div>
                <div class="ts-value" id="sec-rejected-total">‚Çπ 0</div>
            </div>
        </div>

        <!-- NEW: Direct Cash Entry Function -->
        <div class="direct-entry-section">
            <div class="form-wrapper" style="background:none; padding:0; box-shadow:none;">
                <div class="form-section-title" style="margin-top:0; padding-left:0; border-bottom: none;">
                            <span class="section-icon" style="color:#f1c40f;">üí∞</span> Direct Cash Entry
                </div>
                <p style="margin-bottom: 15px; color: #7f8c8d; font-size: 0.9rem;">
                            Use this section to record cash expenses paid directly by the committee. These entries will be <strong>Auto-Approved</strong> and added to the ledger immediately.
                </p>
                
                <div class="grid-2">
                    <div>
                                <label for="Sec_Bill_Date">Date</label>
                                <input type="date" id="Sec_Bill_Date" required="">
                    </div>
                    <div>
                                <label for="Sec_Bill_Amount">Amount (‚Çπ)</label>
                                <input type="number" id="Sec_Bill_Amount" placeholder="0.00" required="" min="1">
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <label for="Sec_Bill_Wing">Requesting Wing / Dept</label>
                    <input type="text" id="Sec_Bill_Wing" value="Treasury Committee (Cash)" required="">
                </div>

                <div style="margin-top: 15px;">
                    <label for="Sec_Bill_Category">Category</label>
                    <select id="Sec_Bill_Category" required="">
                        <option value="" disabled="" selected="">Select Category...</option>
                        <option value="Decoration">Decoration</option>
                        <option value="Food">Food &amp; Refreshments</option>
                        <option value="Transport">Transport</option>
                        <option value="Prizes">Prizes / Gifts</option>
                        <option value="Material">Study Material</option>
                        <option value="Office">Office Supplies</option>
                        <option value="Misc">Miscellaneous</option>
                    </select>
                </div>

                <div style="margin-top: 15px;">
                    <label for="Sec_Bill_Subject">Subject</label>
                    <input type="text" id="Sec_Bill_Subject" placeholder="e.g. Office Cash Purchase" required="">
                </div>

                <div style="margin-top: 15px;">
                    <label for="Sec_Bill_Reason">Reason / Description</label>
                    <textarea id="Sec_Bill_Reason" placeholder="Detailed reason for this expenditure..." required="" style="min-height: 80px;"></textarea>
                </div>

                <button type="button" onclick="submitSecretaryBill()" class="btn-treasure" style="margin-top: 20px;">Post Approved Entry</button>
                
                <div id="sec-bill-error" class="error_box"></div>
            </div>
        </div>
    </div>

    <!-- LIST VIEW TABS -->
    <div class="admin-tabs">
        <button class="admin-tab-btn active" onclick="switchTreasuryTab('incoming')">Incoming Requests</button>
        <button class="admin-tab-btn" onclick="switchTreasuryTab('approved')">Approved Ledger</button>
        <button class="admin-tab-btn" onclick="switchTreasuryTab('rejected')">Rejected / Archive</button>
    </div>

    <!-- Tab: Incoming Requests -->
    <div id="tr-tab-incoming" class="tab-content">
      <div class="table-responsive">
        <table class="ledger-table" id="tr-incoming-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Wing</th>
              <th>Subject</th>
              <th>Category</th>
              <th>Amount</th>
              <th>Receipt</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tr-incoming-tbody"></tbody>
        </table>
      </div>
      <div id="tr-incoming-empty" class="empty-state hidden" style="text-align:center; padding:20px;">No pending bills to review.</div>
    </div>

    <!-- Tab: Approved Ledger -->
    <div id="tr-tab-approved" class="tab-content hidden">
      <div class="table-responsive">
        <table class="ledger-table" id="tr-approved-table">
          <thead>
            <tr>
              <th>Voucher Date</th>
              <th>Wing</th>
              <th>Subject</th>
              <th>Category</th>
              <th>Amount</th>
              <th>Receipt</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="tr-approved-tbody"></tbody>
        </table>
      </div>
      <div id="tr-approved-empty" class="empty-state hidden" style="text-align:center; padding:20px;">No approved bills in ledger.</div>
    </div>

    <!-- Tab: Rejected -->
    <div id="tr-tab-rejected" class="tab-content hidden">
      <div class="table-responsive">
        <table class="ledger-table" id="tr-rejected-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Wing</th>
              <th>Subject</th>
              <th>Category</th>
              <th>Amount</th>
              <th>Reason/Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="tr-rejected-tbody"></tbody>
        </table>
      </div>
      <div id="tr-rejected-empty" class="empty-state hidden" style="text-align:center; padding:20px;">No rejected bills found.</div>
    </div>
  </div>

  <!-- VIEW 5: Core Dashboard -->
  <div id="view-core-dashboard" class="container hidden">
    <h1 style="color: #8e44ad;">Core Committee Dashboard</h1>

    <div class="admin-tabs">
      <button class="admin-tab-btn active" onclick="switchCoreTab('meetings')">Anjuman Meetings</button>
      <button class="admin-tab-btn" onclick="switchCoreTab('programs')">General Programs</button>
      <button class="admin-tab-btn" onclick="switchCoreTab('treasure')">Treasury Overview</button>
    </div>

    <!-- Tab: Core Meetings -->
    <div id="core-tab-meetings" class="tab-content">
      <div class="mini-form">
        <h3>Add Anjuman Meeting Report</h3>
        <form id="add-meeting-form">
          <div class="mini-form-row">
            <input type="text" id="new-meeting-title" placeholder="Meeting Name/Subject (Optional)" style="flex:2">
          </div>
          <div class="mini-form-row">
            <input type="date" id="new-meeting-date" placeholder="Meeting Date" required="">
          </div>
          <div class="mini-form-row" style="margin-top:10px;">
             <label for="new-meeting-agenda" style="flex:1; font-weight:600; font-size:0.9rem; color:#555;">Agenda:</label>
             <textarea id="new-meeting-agenda" placeholder="Enter agenda here..." required="" style="height: 80px; width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; resize:vertical;"></textarea>
          </div>
          <button type="submit" style="margin-top: 15px;">Add Report</button>
        </form>
      </div>
      <div class="table-responsive">
        <table id="meeting-table">
          <thead>
            <tr>
              <th>Meeting Date</th>
              <th>Subject / Agenda</th>
              <th>Submitted By</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="meeting-tbody"></tbody>
        </table>
      </div>
      <div id="meeting-empty" class="empty-state hidden">No meeting reports found.</div>
    </div>

    <!-- Tab: General Programs -->
    <div id="core-tab-programs" class="tab-content hidden">
      <p style="color: #7f8c8d; margin-bottom: 20px; text-align: center;">(View Only - Data managed by Wings)</p>
      <div class="table-responsive">
        <table id="core-program-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Program</th>
              <th>Category</th>
              <th>Wing</th>
            </tr>
          </thead>
          <tbody id="core-program-tbody"></tbody>
        </table>
      </div>
      <div id="core-program-empty" class="empty-state hidden">No program data found.</div>
    </div>

    <!-- Tab: Treasury Overview (WITH FORM) -->
    <div id="core-tab-treasure" class="tab-content hidden">
      <!-- Stats Header -->
      <div id="core-total-treasure-box" class="total-treasure-box" style="background: linear-gradient(135deg, #8e44ad, #703688);">
        <h3>Total Official Expenditure</h3>
        <h2 id="core-grand-total-display">‚Çπ 0</h2>
      </div>
      
      <!-- NEW: Add Official Bill Form -->
      <div class="form-wrapper" style="border-top: 5px solid #8e44ad; margin-bottom: 20px;">
        <div class="form-section-title" style="margin-top:0;">
          <span class="section-icon" style="color:#8e44ad;">üìú</span> Add Official Treasury Entry
        </div>

        <div class="grid-2">
          <div>
            <label for="Core_Bill_Date">Date</label>
            <input type="date" id="Core_Bill_Date" required="">
          </div>

          <div>
            <label for="Core_Bill_Amount">Amount (‚Çπ)</label>
            <input type="number" id="Core_Bill_Amount" placeholder="0.00" required="" min="1">
          </div>
        </div>

        <div style="margin-top: 20px;">
          <label for="Core_Bill_Wing">Requesting Wing / Dept</label>
          <input type="text" id="Core_Bill_Wing" value="Core Committee" required="">
        </div>

        <div style="margin-top: 15px;">
          <label for="Core_Bill_Category">Category</label>
          <select id="Core_Bill_Category" required="">
            <option value="" disabled="" selected="">Select Category...</option>
            <option value="Decoration">Decoration</option>
            <option value="Food">Food &amp; Refreshments</option>
            <option value="Transport">Transport</option>
            <option value="Prizes">Prizes / Gifts</option>
            <option value="Material">Study Material</option>
            <option value="Office">Office Supplies</option>
            <option value="Misc">Miscellaneous</option>
          </select>
        </div>

        <div style="margin-top: 15px;">
          <label for="Core_Bill_Subject">Subject</label>
          <input type="text" id="Core_Bill_Subject" placeholder="e.g. Annual Hall Rent" required="">
        </div>

        <div style="margin-top: 15px;">
          <label for="Core_Bill_Reason">Reason / Description</label>
          <textarea id="Core_Bill_Reason" placeholder="Detailed reason for this expenditure..." required="" style="min-height: 80px;"></textarea>
        </div>

        <div style="margin-top: 15px;">
          <label for="Core_Bill_Receipt">Receipt Upload (Optional)</label>
          <input type="file" id="Core_Bill_Receipt" accept="image/*,.pdf">
        </div>

        <button type="button" onclick="submitCoreBill()" class="btn-core" style="margin-top: 20px;">Post Official Entry</button>
        
        <div id="core-bill-error" class="error_box"></div>
        <div id="core-bill-success" class="success_box"></div>
      </div>

      <!-- Existing Table View -->
      <h3 style="text-align: left; margin-bottom: 15px; color: #2c3e50;">Current Ledger</h3>
      <div class="table-responsive">
        <table id="core-treasure-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Wing</th>
              <th>Subject</th>
              <th>Category</th>
              <th>Reason</th>
              <th>Amount</th>
              <th>Receipt</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="core-treasure-tbody"></tbody>
        </table>
      </div>
      <div id="core-treasure-empty" class="empty-state hidden">No treasure data found.</div>
    </div>

  </div>

  <!-- Modals -->
  <div class="modal" id="detail-modal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal()">√ó</button>
      <h2 style="margin-top:0; border-bottom: 2px solid #eee; padding-bottom: 10px;">Report Details</h2>
      <div id="modal-body" style="line-height: 1.8;"></div>
    </div>
  </div>

  <div class="modal" id="student-modal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeStudentModal()">√ó</button>
      <h2 id="student-modal-name" style="margin-top:0; border-bottom: 2px solid #eee; padding-bottom: 10px;">Student Profile</h2>
      <div id="student-modal-body" style="line-height: 1.8;"></div>
    </div>
  </div>

  <div class="modal" id="class-modal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeClassModal()">√ó</button>
      <h2 id="class-modal-name" style="margin-top:0; border-bottom: 2px solid #eee; padding-bottom: 10px;">Class Details</h2>
      <div id="class-modal-body" style="line-height: 1.8;"></div>
    </div>
  </div>

  <div class="modal" id="meeting-modal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeMeetingModal()">√ó</button>
      <h2 style="margin-top:0; border-bottom: 2px solid #eee; padding-bottom: 10px;">Meeting Details</h2>
      <div id="meeting-modal-body" style="line-height: 1.8;"></div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast-container"></div>

<script>
  // ===========================
  // 1. Configuration & Data Seeding
  // ===========================
  const DEFAULT_ADMIN_PASS = "admin123";
  const DEFAULT_CORE_PASS = "core123";
  const DEFAULT_TREASURY_USER = "treasurer";
  const DEFAULT_TREASURY_PASS = "treasure123";
 
  const defaultWings = [
    { name: "Tech Wing", username: "tech", password: "123" },
    { name: "Urdu Wing", username: "urdu", password: "123" },
    { name: "Arabic Wing", username: "arabic", password: "123" },
    { name: "English Wing", username: "english", password: "123" },
    { name: "Math & Science Wing", username: "math", password: "123" },
    { name: "General Knowledge Wing", username: "gk", password: "123" },
    { name: "Tazkiya Wing", username: "tazkiya", password: "123" },
    { name: "Sport Club", username: "sport", password: "123" }
  ];

  // Student Data
  const students = {
    U7: ["Sadaf Ziya","Sufiyan Ahmed Raza","Mohd Sahil","Muhammed Sibgathullah","Md Zeeshan Shaikh","Md Zaid Raza","Abbu Shahma","Gulam Dastageer","Tasuif Ansari","MOHD FAISAL","Md Firoz Alam","Asjad Raza","md mosaheb ali","Md Shamshad","Md Achhe Miyan","Hanzala Maqsoom","Hasan Raza","Thajudheen","Rehan Ahmed","Kaunain","Afran Shaikh","Arsalan","Md Sabir","Ulfat Hussain"],
    U6: ["Sadan","NASIR HUSSAIN","Abdul Shadik","Faizan","Jahid Akhatar","MOHAMMAD REHAN","Mohammad Zaid Multani","Munavvar Raza","MOHD ATAULLAH","MD REHAN RAZA","Md Saddam Husain","Dilshad Ansari","Ayan Khan","JUNAID AKHTAR","HASAN WASEEM","MOHD SHAHBAZ","Muzakkir Ansari","Md Manajrul Haque"],
    U5: ["FAHAD AHMAD","ARIF Hussain","JAUHAR TANVIR","MUHAMMAD SHAFEE ALAM","MD RAHMATHULLAH ANSARI","SHEKH NABIL","SHAFEEQURRAHMAN","HASAN RAZA","MO ASAR ALI","Mohammed Rahil","MUHAMMAD SHOAIB ALAM","Abu talib","MD RIZWAN AHMED","FAIZ MOHAMMED PATHAN","MUHAMMED IMRAN RAIN","S SALMAN FARIS","Avesh","MD ASHGAR ALI","ZAID AHMED","AHMED ISMAIL","Md Raihan Raja Noori","Md Aaftab","Arman Khan","Ahmad Raza"],
    U4: ["AHSAN ANSARI","SHAHIL ALI","MD MUSTUPHA Rain","MOHD HUZAIFA ANSARI","SHAMSUDDIN Hashimi","GULAM YAZDANI","AMAN ARSHAD","MD YUSUF ALI Shaikh","JUNAID ANSARI","ATIF NEYAZ Shaikh","MERAJ KHAN","MUBASHIR RAZA","FARHAN RAZA ANSARI","MOKARRAM FAIZ","MOHD ANAS Ansari","MOHD KAISH ANSARI","ZULQARNAIN Shaikh","MD HASAN","MD MUDASSIR","MD ARIF KHAN","SHAHBAZ ANSARI ANSARI","HASHMATH RAZA","MD NEMATULLAH","MD TAUSIF RAZA ANSARI","HAMJA ALI","MOHD FAIZAN","SYED ABDUL AHAD SYED","MUHAMMED AHMED","ZEESHAN KHAN","Md Esmathullah","AHMAD RAJA","AHAD Abbasi"],
    U3: ["ARIF IQBAL","AMIR RAZA","SAKLAIN RAZA","MD SIBTEN RAJA","MOHD HARIS","MOHD. ROMAAN","HUSSAIN AKHTAR RAZA","MOHAMMED","SHAHNAWAJ HUSSAIN","SYED DANIYAL HASAN","SUFIYAN AHMAD KARIMI","MD WAQID RAZA","MOHD TANVEER","SHAHANSHAH ALAM","MD LARIAB","MD ADNAN","MD ARSALAN RAZA","SYED ASJAD IQBAL","MOHAMMAD ANSARI","MINHAJ ALAM","MOHD ALI","MD MOHIBUL","MD SAKIR Shaikh","MD AZMAL REHAN","MD MOJAHIR ALI","MD MOINUDDIN","SAHAWAZ ANSARI","TANZIRUL RAHMAN","SHAHNAWAZ NOUSHAD AHMAD","FAIZ RAJA","MD ANAS","HASNAIN AHMED SHEIKH","ATHAR RZA","HAMMAD RAZA SHAIKH","MOHAMMAD AATIF","MD MOGISH RAZA","FARAZ KHAN","MD. ALMOTALI"],
    U2: ["TANVEER","SAMEER","BILAL","ZIKRULLAH","ASAD","FAIZAN(BR)","IJMAMUL","ASHRAF(JH)","SAGIR","HIFZUR RAHMAN","SAEED","ANAS","SIKANDAR","HAMID","IRFAN","MUSHAHID","SHAYAN","MUKKADDAS","MUDDASSIR","SABAULLAH","HABIBULLAH","S.AMMAR","NURULAIN","SAEEDUR-R","ZIYAULLAH","ABU SHAHMA","ABUBAKAR","KAIF","ZEESHAN(BR)","SUHAIL","ABU KHUZAIMA","FAIZAN(MP)","ASHRAF(UP)","SAJID","MUZAMMIL","SUFIYAN","ROOH FAIZ","TAHSEEN"],
    U1: ["Md Azmat Ansari","Aminul Huq","Mishbaul haq","ANAS MAHBOOB","Mohammad zilan Raza multani","Md Chand Babu","Shahadat Babu","Faizan","AAMIR AZIZ","MD FURQUAN","Mohammed Faheem Pathan","MD WASIULLAH","Mo Rehan Raza","Mohd Asad","Abu Hamza","MOHAMMED AZHAN","Mohd Afjal","ZAINI DAHLAN","Md siptan raja","Mohammad Farhan","mohammad azam qadri","Mo. Ahamad","Aawesh Raza","mohammad rumaiz qasim","Faizane Mustafa","ANIS RAJA","Ariz hamza","Mohd Mohiuddin","Mohammad Rehan","Md rehan raja mansuri","Affan Reza","Ashwad Ansari","ZEYAD ALAM","Siftanin Rza","mohammad jaiyadur rabbani","MUHAMMED NIHAL ALI","Muhammed Junais","Tayal Tufail","Mohammad Waqarul Qadri","Tatheer","Anas Khan","AAZAR ALI","Fidaul mustafa","Md Asif Raza"]
  };

  const groupClassesList = [
    "AL HIKMA FRIENDS", "Afnan Mates", "SHAAD FRIENDS", 
    "Al Misbah Friends", "AL-swaba", "SIDRA FRIENDS", "Al wahda"
  ];

  function loadStudents(className, listId) {
    const list = document.getElementById(listId);
    list.innerHTML = "";
    if(students[className]) {
        students[className].forEach(name => {
            if(name !== "[DELETED]") {
                const opt = document.createElement("option");
                opt.value = name;
                list.appendChild(opt);
            }
        });
    }
  }

  function updateHolderDropdowns() {
    const category = document.getElementById('Pro_Category').value;
    const isGroupCategory = (category === 'Arts group' || category === 'Sport group');
    const holderSelectIds = ['h1_class', 'h2_class', 'h3_class'];

    holderSelectIds.forEach(id => {
        const select = document.getElementById(id);
        const existingGroupOption = select.querySelector('option[value="AL HIKMA FRIENDS"]');

        if (isGroupCategory) {
            if (!existingGroupOption) {
                groupClassesList.forEach(gName => {
                    const opt = document.createElement('option');
                    opt.value = gName;
                    opt.textContent = gName;
                    select.appendChild(opt);
                });
            }
        } else {
            if (existingGroupOption) {
                groupClassesList.forEach(gName => {
                    const opt = select.querySelector(`option[value="${gName}"]`);
                    if (opt) opt.remove();
                });
            }
        }
    });
  }

  function jsEscape(str) {
      return str.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
  }

  // ===========================
  // 1. System Config Management
  // ===========================
  function initSystemConfig() {
      let config = JSON.parse(localStorage.getItem('sys_config'));
      if (!config) {
          config = {
              admin: DEFAULT_ADMIN_PASS,
              core: DEFAULT_CORE_PASS,
              treasuryUser: DEFAULT_TREASURY_USER,
              treasuryPass: DEFAULT_TREASURY_PASS
          };
          localStorage.setItem('sys_config', JSON.stringify(config));
      }
  }

  function getSystemConfig() {
      return JSON.parse(localStorage.getItem('sys_config')) || {
          admin: DEFAULT_ADMIN_PASS,
          core: DEFAULT_CORE_PASS,
          treasuryUser: DEFAULT_TREASURY_USER,
          treasuryPass: DEFAULT_TREASURY_PASS
      };
  }

  function renderSettings() {
      const config = getSystemConfig();
      document.getElementById('settings-admin-pass').value = config.admin;
      document.getElementById('settings-core-pass').value = config.core;
      document.getElementById('settings-treasury-user').value = config.treasuryUser;
      document.getElementById('settings-treasury-pass').value = config.treasuryPass; 
  }

  function saveSettings() {
    const adminPass = document.getElementById('settings-admin-pass').value;
    const corePass = document.getElementById('settings-core-pass').value;
    const treasUser = document.getElementById('settings-treasury-user').value;
    const treasPass = document.getElementById('settings-treasury-pass').value;

    if (!adminPass || !corePass || !treasUser || !treasPass) {
        alert("Please fill in all required fields.");
        return;
    }

    const newConfig = {
        admin: adminPass,
        core: corePass,
        treasuryUser: treasUser,
        treasuryPass: treasPass
    };

    localStorage.setItem('sys_config', JSON.stringify(newConfig));
    
    showToast('System Configuration Updated', 'success');
    renderSettings();
  }


  window.addEventListener('DOMContentLoaded', () => {
    let clubs = localStorage.getItem('clubsData');
    if (clubs) {
      clubs = JSON.parse(clubs);
      if (clubs.length > 0 && typeof clubs[0] === 'string') {
        localStorage.setItem('clubsData', JSON.stringify(defaultWings));
      }
    } else {
      localStorage.setItem('clubsData', JSON.stringify(defaultWings));
    }
    
    // Init System Config
    initSystemConfig();

    if (!localStorage.getItem('usersData')) localStorage.setItem('usersData', JSON.stringify([]));
    if (!localStorage.getItem('programData')) localStorage.setItem('programData', JSON.stringify([]));
    if (!localStorage.getItem('meetingData')) localStorage.setItem('meetingData', JSON.stringify([]));
    if (!localStorage.getItem('billData')) localStorage.setItem('billData', JSON.stringify([]));

    populateLoginWingDropdown();
    populateUserDatalist();
  });

  let currentUser = null;

  // ===========================
  // 2. Navigation & View Logic
  // ===========================
  const views = {
    login: document.getElementById('view-login'),
    wing: document.getElementById('view-wing-dashboard'),
    dashboard: document.getElementById('view-dashboard'),
    treasury: document.getElementById('view-treasury-dashboard'),
    core: document.getElementById('view-core-dashboard')
  };

  function showView(viewName) {
    Object.values(views).forEach(el => el.classList.add('hidden'));
    views[viewName].classList.remove('hidden');
    if (viewName !== 'login') document.getElementById('main-nav').classList.remove('hidden');
    else document.getElementById('main-nav').classList.add('hidden');
  }

  function toggleLoginTab(type) {
    document.querySelectorAll('.login-tab-btn').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    
    document.getElementById('wing-login-form').classList.add('hidden');
    document.getElementById('admin-login-form').classList.add('hidden');
    document.getElementById('treasury-login-form').classList.add('hidden');
    document.getElementById('core-login-form').classList.add('hidden');

    if (type === 'wing') document.getElementById('wing-login-form').classList.remove('hidden');
    else if (type === 'admin') document.getElementById('admin-login-form').classList.remove('hidden');
    else if (type === 'treasury') document.getElementById('treasury-login-form').classList.remove('hidden');
    else if (type === 'core') document.getElementById('core-login-form').classList.remove('hidden');
  }

  // ===========================
  // 3. Authentication Logic
  // ===========================
  function populateLoginWingDropdown() {
    const clubs = JSON.parse(localStorage.getItem('clubsData'));
    const select = document.getElementById('login-wing-select');
    select.innerHTML = '<option value="" disabled selected>Select your Wing...</option>';
    clubs.forEach(c => select.innerHTML += `<option value="${c.name}">${c.name}</option>`);
  }

  document.getElementById('wing-login-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const wingName = document.getElementById('login-wing-select').value;
    const user = document.getElementById('login-wing-user').value.trim();
    const pass = document.getElementById('login-wing-pass').value.trim();
    const clubs = JSON.parse(localStorage.getItem('clubsData'));
    const wing = clubs.find(c => c.name === wingName);

    if (wing && wing.username === user && wing.password === pass) {
      currentUser = { role: 'wing', wingName: wing.name };
      document.getElementById('user-display-name').textContent = wing.name;
      document.getElementById('nav-brand-text').textContent = "Wing Portal";
      showToast(`Welcome, ${wing.name}`, 'success');
      prepareWingForms(wing.name);
      showView('wing');
    } else {
      showToast('Invalid Username or Password', 'error');
    }
  });

  document.getElementById('admin-login-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const config = getSystemConfig(); // Get dynamic password
    if (document.getElementById('admin-master-pass').value.trim() === config.admin) {
      currentUser = { role: 'admin' };
      document.getElementById('user-display-name').textContent = "Administrator";
      document.getElementById('nav-brand-text').textContent = "Admin Dashboard";
      showToast('Admin Login Success', 'success');
      renderReports();
      renderTreasureReports();
      showView('dashboard');
    } else showToast('Incorrect Admin Password', 'error');
  });

  document.getElementById('treasury-login-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const config = getSystemConfig();
    const user = document.getElementById('treasury-user').value.trim();
    const pass = document.getElementById('treasury-pass').value.trim();
    
    // DYNAMIC LOGIN: Check against stored config
    if (user === config.treasuryUser && pass === config.treasuryPass) {
      currentUser = { role: 'treasury' };
      document.getElementById('user-display-name').textContent = "Treasury Secretary";
      document.getElementById('nav-brand-text').textContent = "Treasury Committee";
      showToast('Treasury Login Success', 'success');
      renderTreasuryDashboard();
      showView('treasury');
    } else {
      showToast('Invalid Treasury Credentials', 'error');
    }
  });

  document.getElementById('core-login-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const config = getSystemConfig();
    const user = document.getElementById('core-login-user').value.trim();
    const pass = document.getElementById('core-login-pass').value.trim();
    
    // DYNAMIC LOGIN: Check against stored config
    if (user === 'core' && pass === config.core) {
      currentUser = { role: 'core' };
      document.getElementById('user-display-name').textContent = "Core Committee";
      document.getElementById('nav-brand-text').textContent = "Core Dashboard";
      showToast('Core Login Success', 'success');
      renderCoreMeetings();
      renderCoreReports();
      renderCoreTreasureReports();
      showView('core');
    } else {
      showToast('Invalid Core Credentials', 'error');
    }
  });

  function handleLogout() {
    currentUser = null;
    document.getElementById('wing-login-form').reset();
    document.getElementById('admin-login-form').reset();
    document.getElementById('treasury-login-form').reset();
    document.getElementById('core-login-form').reset();
    showView('login');
    showToast('Logged out', 'success');
  }

  // ===========================
  // 4. Wing Dashboard Logic
  // ===========================
  function prepareWingForms(wingName) {
    const wingSelect = document.getElementById('Wing');
    wingSelect.innerHTML = `<option value="${wingName}" selected>${wingName}</option>`;
    document.getElementById('Pro_Category').value = "";
    updateHolderDropdowns();

    const billWingSelect = document.getElementById('Bill_Wing');
    billWingSelect.innerHTML = `<option value="${wingName}" selected>${wingName}</option>`;
  }

  function switchWingTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
    document.querySelectorAll('.admin-tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`wing-tab-${tabName}`).classList.remove('hidden');
    event.target.classList.add('active');
  }

  // --- Wing: Program Form Logic ---
  const MyForm = document.querySelector("#sheetdb-form");
  const ErrorBox = document.querySelector('.error_box');
  const Poster_Input = document.querySelector('#Poster');

  MyForm.addEventListener("submit", (event) => {
    event.preventDefault();
    let isValid = true;
    MyForm.querySelectorAll('[required]').forEach(field => { if (!field.value.trim()) isValid = false; });
    if (!isValid) {
      ErrorBox.textContent = "Please fill all required fields.";
      ErrorBox.style.display = 'block';
      return;
    }

    const btn = document.getElementById('submit-btn');
    btn.disabled = true;
    btn.textContent = 'Saving...';
    ErrorBox.style.display = 'none';

    fetch(MyForm.action, { method: "POST", body: new FormData(MyForm) })
      .then(response => response.json())
      .then(() => {
        const entry = {
          id: Date.now(),
          date: document.getElementById('Pro_Date').value,
          name: document.getElementById('Pro_Name').value,
          category: document.getElementById('Pro_Category').value,
          wing: document.getElementById('Wing').value,
          poster: Poster_Input.files[0] ? Poster_Input.files[0].name : "No file",
          description: document.getElementById('Pro_Dic').value,
          outcomes: document.getElementById('Pro_Outcome').value,
          h1_name: document.getElementById('firstHolder').value,
          h1_class: document.getElementById('h1_class').value,
          h2_name: document.getElementById('secondHolder').value,
          h2_class: document.getElementById('h2_class').value,
          h3_name: document.getElementById('thirdHolder').value,
          h3_class: document.getElementById('h3_class').value
        };
       
        let data = JSON.parse(localStorage.getItem('programData')) || [];
        data.push(entry);
        localStorage.setItem('programData', JSON.stringify(data));

        showToast('Program Saved Successfully!', 'success');
        MyForm.reset();
        prepareWingForms(currentUser.wingName);
      })
      .catch(err => {
        console.error(err);
        ErrorBox.textContent = "Network Error.";
        ErrorBox.style.display = 'block';
      })
      .finally(() => {
        btn.disabled = false;
        btn.textContent = 'Save Report';
      });
  });

  // --- Wing: Treasure/Bill Form Logic ---
  const TreasureForm = document.querySelector("#treasure-form");
  const BillErrorBox = document.getElementById('bill-error');
  const BillReceiptInput = document.getElementById('Bill_Receipt');

  TreasureForm.addEventListener("submit", (event) => {
    event.preventDefault();
    let isValid = true;
    TreasureForm.querySelectorAll('[required]').forEach(field => { if (!field.value.trim()) isValid = false; });
    if (!isValid) {
      BillErrorBox.textContent = "Please fill all required fields.";
      BillErrorBox.style.display = 'block';
      return;
    }

    const btn = document.getElementById('submit-bill-btn');
    btn.disabled = true;
    btn.textContent = 'Submitting...';
    BillErrorBox.style.display = 'none';

    fetch(TreasureForm.action, { method: "POST", body: new FormData(TreasureForm) })
      .then(response => response.json())
      .then(() => {
        const entry = {
          id: Date.now(),
          date: document.getElementById('Bill_Date').value,
          wing: document.getElementById('Bill_Wing').value,
          amount: document.getElementById('Bill_Amount').value,
          category: document.getElementById('Bill_Category').value,
          subject: document.getElementById('Bill_Subject').value,
          description: document.getElementById('Bill_Desc').value,
          receipt: BillReceiptInput.files[0] ? BillReceiptInput.files[0].name : "No Receipt",
          status: 'Pending' 
        };
       
        let data = JSON.parse(localStorage.getItem('billData')) || [];
        data.push(entry);
        localStorage.setItem('billData', JSON.stringify(data));

        showToast('Bill Submitted for Approval!', 'success');
        TreasureForm.reset();
        prepareWingForms(currentUser.wingName);
      })
      .catch(err => {
        console.error(err);
        BillErrorBox.textContent = "Network Error.";
        BillErrorBox.style.display = 'block';
      })
      .finally(() => {
        btn.disabled = false;
        btn.textContent = 'Submit Bill for Approval';
      });
  });

  // ===========================
  // 5. Admin Dashboard Logic (General)
  // ===========================
  function switchAdminTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
    document.querySelectorAll('.admin-tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`adm-tab-${tabName}`).classList.remove('hidden');
    event.target.classList.add('active');
    if (tabName === 'reports') renderReports();
    if (tabName === 'clubs') renderClubsAdmin();
    if (tabName === 'users') renderUsers();
    if (tabName === 'leaderboard') renderLeaderboard();
    if (tabName === 'class-leaderboard') renderClassLeaderboard();
    if (tabName === 'treasure') renderTreasureReports();
    if (tabName === 'settings') renderSettings(); // NEW: Render settings
  }

  function renderDashboardStats() {
    const programs = JSON.parse(localStorage.getItem('programData')) || [];
    const clubs = JSON.parse(localStorage.getItem('clubsData')) || [];
    const container = document.getElementById('stats-container');
    container.innerHTML = '';

    const totalCard = document.createElement('div');
    totalCard.className = 'stat-card total';
    totalCard.innerHTML = `<h3>Total Programs</h3><span class="stat-value">${programs.length}</span>`;
    container.appendChild(totalCard);

    clubs.forEach(club => {
      const wingCount = programs.filter(p => p.wing === club.name).length;
      const card = document.createElement('div');
      card.className = 'stat-card';
      card.innerHTML = `<h4>${club.name}</h4><span class="stat-value">${wingCount}</span>`;
      container.appendChild(card);
    });
  }

  function renderReports() {
    const data = JSON.parse(localStorage.getItem('programData')) || [];
    const tbody = document.getElementById('report-tbody');
    const emptyMsg = document.getElementById('report-empty');
    tbody.innerHTML = '';
    if (data.length === 0) { emptyMsg.classList.remove('hidden'); document.getElementById('report-table').classList.add('hidden'); }
    else { 
      emptyMsg.classList.add('hidden'); document.getElementById('report-table').classList.remove('hidden'); 
    }
    renderDashboardStats();
    data.sort((a, b) => new Date(b.date) - new Date(a.date));
    data.forEach(item => {
      const h1 = item.h1_name ? `${item.h1_name} (${item.h1_class})` : '-';
      const h2 = item.h2_name ? `${item.h2_name} (${item.h2_class})` : '';
      const h3 = item.h3_name ? `${item.h3_name} (${item.h3_class})` : '';
      const holders = [h1, h2, h3].filter(n => n).join(', ');
      const catBadge = item.category ? `<span class="cat-badge">${item.category}</span>` : '-';
      
      const esc = (txt) => txt ? txt.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : '';
      const formatName = (name) => {
        if (name === "[DELETED]") return `<span style="color:#e74c3c; font-weight:bold;">${esc(name)}</span>`;
        return esc(name);
      };

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.date}</td>
        <td><strong>${formatName(item.name)}</strong></td>
        <td>${catBadge}</td>
        <td>${item.wing}</td>
        <td>
          <button class="btn-view" onclick="viewDetails(${item.id})">View</button>
          <button class="btn-delete" onclick="deleteReport(${item.id})">Del</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  function deleteReport(id) {
    if(!confirm("Delete this report?")) return;
    let data = JSON.parse(localStorage.getItem('programData')) || [];
    data = data.filter(i => i.id !== id);
    localStorage.setItem('programData', JSON.stringify(data));
    renderReports();
    showToast('Deleted', 'success');
  }

  function renderClubsAdmin() {
    const clubs = JSON.parse(localStorage.getItem('clubsData')) || [];
    const tbody = document.getElementById('club-tbody');
    tbody.innerHTML = '';
    clubs.forEach((c, index) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${c.name}</td>
        <td><code>${c.username}</code></td>
        <td><code>${c.password}</code></td>
        <td><button class="btn-delete" onclick="deleteClub(${index})">Delete</button></td>`;
      tbody.appendChild(tr);
    });
  }

  document.getElementById('add-club-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const name = document.getElementById('new-club-name').value.trim();
    const user = document.getElementById('new-club-user').value.trim();
    const pass = document.getElementById('new-club-pass').value.trim();
    if (name && user && pass) {
      let clubs = JSON.parse(localStorage.getItem('clubsData')) || [];
      if (clubs.find(c => c.name === name)) { showToast('Wing already exists', 'error'); return; }
      clubs.push({ name, username: user, password: pass });
      localStorage.setItem('clubsData', JSON.stringify(clubs));
      document.getElementById('add-club-form').reset();
      renderClubsAdmin();
      populateLoginWingDropdown();
      showToast('Wing Added', 'success');
    }
  });

  function deleteClub(index) {
    if(!confirm("Delete this Wing?")) return;
    let clubs = JSON.parse(localStorage.getItem('clubsData')) || [];
    clubs.splice(index, 1);
    localStorage.setItem('clubsData', JSON.stringify(clubs));
    renderClubsAdmin();
    populateLoginWingDropdown();
    showToast('Deleted', 'success');
  }

  function renderUsers() {
    const users = JSON.parse(localStorage.getItem('usersData')) || [];
    const tbody = document.getElementById('user-tbody');
    tbody.innerHTML = '';
    users.forEach(u => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${u.name}</td><td><button class="btn-delete" onclick="deleteUser(${u.id})">Del</button></td>`;
      tbody.appendChild(tr);
    });
  }
  document.getElementById('add-user-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const name = document.getElementById('new-user-name').value.trim();
    let users = JSON.parse(localStorage.getItem('usersData')) || [];
    users.push({ id: Date.now(), name: name });
    localStorage.setItem('usersData', JSON.stringify(users));
    e.target.reset();
    renderUsers();
    populateUserDatalist();
    showToast('User Added', 'success');
  });
  function deleteUser(id) {
    if(!confirm("Delete user?")) return;
    let users = JSON.parse(localStorage.getItem('usersData')) || [];
    users = users.filter(u => u.id !== id);
    localStorage.setItem('usersData', JSON.stringify(users));
    renderUsers();
    populateUserDatalist();
  }
  function populateUserDatalist() {
    const users = JSON.parse(localStorage.getItem('usersData')) || [];
    const dl = document.getElementById('user-suggestions');
    if(!dl) return;
    dl.innerHTML = '';
    users.forEach(u => { const opt = document.createElement('option'); opt.value = u.name; dl.appendChild(opt); });
  }

  // ===========================
  // 6. Scoring Logic
  // ===========================
  function getPointsForRole(category, className, role) {
      const isGroupCategory = (category && category.includes('group')); 
      const isSpecialGroup = groupClassesList.includes(className);

      if (isGroupCategory && isSpecialGroup) {
          if (role === 1) return 50;
          if (role === 2) return 40;
          if (role === 3) return 30;
      } else {
          if (role === 1) return 10;
          if (role === 2) return 7;
          if (role === 3) return 5;
      }
      return 0;
  }

  function calculateStudentPoints() {
    const programs = JSON.parse(localStorage.getItem('programData')) || [];
    const stats = {};

    programs.forEach(prog => {
      if(prog.h1_name && prog.h1_name !== "[DELETED]") {
        const pts = getPointsForRole(prog.category, prog.h1_class, 1);
        stats[prog.h1_name] = (stats[prog.h1_name] || 0) + pts;
      }
      if(prog.h2_name && prog.h2_name !== "[DELETED]") {
        const pts = getPointsForRole(prog.category, prog.h2_class, 2);
        stats[prog.h2_name] = (stats[prog.h2_name] || 0) + pts;
      }
      if(prog.h3_name && prog.h3_name !== "[DELETED]") {
        const pts = getPointsForRole(prog.category, prog.h3_class, 3);
        stats[prog.h3_name] = (stats[prog.h3_name] || 0) + pts;
      }
    });

    const hasDeleted = programs.some(p => p.h1_name === "[DELETED]");
    if(hasDeleted) stats["[DELETED]"] = 0;

    const sorted = Object.keys(stats).map(name => ({
        name: name,
        points: stats[name]
    })).sort((a,b) => b.points - a.points);

    return sorted;
  }

  function deleteStudent(studentName) {
      if(!confirm("Are you sure you want to remove this student's points from all programs?")) return;
      let data = JSON.parse(localStorage.getItem('programData')) || [];
      let modified = false;

      data.forEach(p => {
          if(p.h1_name === studentName) { p.h1_name = "[DELETED]"; p.h1_class = "[DELETED]"; modified = true; }
          if(p.h2_name === studentName) { p.h2_name = "[DELETED]"; p.h2_class = "[DELETED]"; modified = true; }
          if(p.h3_name === studentName) { p.h3_name = "[DELETED]"; p.h3_class = "[DELETED]"; modified = true; }
      });
      
      if(modified) {
          localStorage.setItem('programData', JSON.stringify(data));
          renderLeaderboard();
      }
      showToast('Student Points Removed', 'success');
  }

  function renderLeaderboard() {
    const studentsData = calculateStudentPoints();
    const tbody = document.getElementById('student-leaderboard-tbody');
    const emptyMsg = document.getElementById('student-leaderboard-empty');
    const table = document.getElementById('student-leaderboard-table');
    
    tbody.innerHTML = '';

    if (studentsData.length === 0) {
        emptyMsg.classList.remove('hidden');
        table.classList.add('hidden');
        return;
    }
    
    emptyMsg.classList.add('hidden');
    table.classList.remove('hidden');

    studentsData.forEach((student, index) => {
        const isDeleted = student.name === "[DELETED]";
        const rowClass = isDeleted ? 'deleted-row' : '';
        
        let rankClass = '';
        let rankDisplay = index + 1;
        if (index === 0) { rankClass = 'rank-1'; rankDisplay = 'ü•á 1st'; }
        else if (index === 1) { rankClass = 'rank-2'; rankDisplay = 'ü•à 2nd'; }
        else if (index === 2) { rankClass = 'rank-3'; rankDisplay = 'ü•â 3rd'; }

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="${rankClass}">${rankDisplay}</td>
            <td class="${rowClass}">${student.name}</td>
            <td class="${rowClass}" style="font-weight:bold; font-size:1.1rem; color:#3498db;">${student.points}</td>
            <td>
                <button class="btn-view" onclick="viewStudentProfile('${jsEscape(student.name)}')">View</button>
                ${!isDeleted ? `<button class="btn-delete" onclick="deleteStudent('${jsEscape(student.name)}')">Del</button>` : ''}
            </td>
        `;
        tbody.appendChild(tr);
    });
  }

  function viewStudentProfile(studentName) {
    const programs = JSON.parse(localStorage.getItem('programData')) || [];
    const history = programs.filter(p => 
        p.h1_name === studentName || 
        p.h2_name === studentName || 
        p.h3_name === studentName
    );

    let historyHtml = history.length === 0 ? '<p>No participation history found.</p>' : '';

    const isDeletedProfile = (studentName === "[DELETED]");
    const headerTitle = isDeletedProfile ? `${studentName}'s Profile (DELETED)` : `${studentName}'s Profile`;
    document.getElementById('student-modal-name').textContent = headerTitle;

    history.forEach(p => {
        let role = '';
        let pts = 0;
        let className = '';

        if(p.h1_name === studentName) { role = '1st Holder'; className = p.h1_class; }
        else if(p.h2_name === studentName) { role = '2nd Holder'; className = p.h2_class; }
        else if(p.h3_name === studentName) { role = '3rd Holder'; className = p.h3_class; }

        pts = getPointsForRole(p.category, className, (role.includes('1st') ? 1 : role.includes('2nd') ? 2 : 3));

        historyHtml += `
            <div style="border-bottom:1px solid #eee; padding:10px 0; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div style="font-weight:bold; color:#2c3e50;">${p.name}</div>
                    <div style="font-size:0.85rem; color:#7f8c8d;">${p.date} | ${p.wing} | ${p.category || '-'}</div>
                    <div style="font-size:0.8rem; color:#95a5a6;">Class: ${className}</div>
                </div>
                <div style="text-align:right;">
                    <div style="font-weight:bold; color:#27ae60;">+${pts} pts</div>
                    <div style="font-size:0.8rem; color:#7f8c8d;">${role}</div>
                </div>
            </div>
        `;
    });

    document.getElementById('student-modal-body').innerHTML = historyHtml;
    document.getElementById('student-modal').classList.add('active');
  }

  function closeStudentModal() {
      document.getElementById('student-modal').classList.remove('active');
  }

  // --- Class Leaderboard ---
  function calculateClassPoints() {
    const programs = JSON.parse(localStorage.getItem('programData')) || [];
    const stats = {};

    programs.forEach(prog => {
        const isTargetCategory = (prog.category === 'Arts group' || prog.category === 'Sport group');

        if (isTargetCategory) {
            if(prog.h1_class && prog.h1_class !== "[DELETED]") {
                stats[prog.h1_class] = (stats[prog.h1_class] || 0) + 50;
            }
            if(prog.h2_class && prog.h2_class !== "[DELETED]") {
                stats[prog.h2_class] = (stats[prog.h2_class] || 0) + 40;
            }
            if(prog.h3_class && prog.h3_class !== "[DELETED]") {
                stats[prog.h3_class] = (stats[prog.h3_class] || 0) + 30;
            }
        }
    });

    const hasDeleted = programs.some(p => p.h1_class === "[DELETED]");
    if(hasDeleted) stats["[DELETED]"] = 0;

    const sorted = Object.keys(stats).map(name => ({
        name: name,
        points: stats[name]
    })).sort((a,b) => b.points - a.points);

    return sorted;
  }

  function deleteClass(className) {
      if(!confirm("Remove this Class/Group's points from programs?")) return;
      let data = JSON.parse(localStorage.getItem('programData')) || [];
      let modified = false;

      data.forEach(p => {
          if(p.h1_class === className) { p.h1_name = "[DELETED]"; p.h1_class = "[DELETED]"; modified = true; }
          if(p.h2_class === className) { p.h2_name = "[DELETED]"; p.h2_class = "[DELETED]"; modified = true; }
          if(p.h3_class === className) { p.h3_name = "[DELETED]"; p.h3_class = "[DELETED]"; modified = true; }
      });

      if(modified) {
          localStorage.setItem('programData', JSON.stringify(data));
          renderClassLeaderboard();
      }
      showToast('Class Points Removed', 'success');
  }

  function renderClassLeaderboard() {
    const classData = calculateClassPoints();
    const tbody = document.getElementById('class-leaderboard-tbody');
    const emptyMsg = document.getElementById('class-leaderboard-empty');
    const table = document.getElementById('class-leaderboard-table');

    tbody.innerHTML = '';

    if (classData.length === 0) {
        emptyMsg.classList.remove('hidden');
        table.classList.add('hidden');
        return;
    }

    emptyMsg.classList.add('hidden');
    table.classList.remove('hidden');

    classData.forEach((cls, index) => {
        const isDeleted = cls.name === "[DELETED]";
        const rowClass = isDeleted ? 'deleted-row' : '';

        let rankClass = '';
        let rankDisplay = index + 1;
        if (index === 0) { rankClass = 'rank-1'; rankDisplay = 'ü•á 1st'; }
        else if (index === 1) { rankClass = 'rank-2'; rankDisplay = 'ü•à 2nd'; }
        else if (index === 2) { rankClass = 'rank-3'; rankDisplay = 'ü•â 3rd'; }

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="${rankClass}">${rankDisplay}</td>
            <td class="${rowClass}">${cls.name}</td>
            <td class="${rowClass}" style="font-weight:bold; font-size:1.1rem; color:#3498db;">${cls.points}</td>
            <td>
                <button class="btn-view" onclick="viewClassProfile('${jsEscape(cls.name)}')">View</button>
                ${!isDeleted ? `<button class="btn-delete" onclick="deleteClass('${jsEscape(cls.name)}')">Del</button>` : ''}
            </td>
        `;
        tbody.appendChild(tr);
    });
  }

  function viewClassProfile(className) {
    const programs = JSON.parse(localStorage.getItem('programData')) || [];
    
    const history = programs.filter(p => 
        (p.h1_class === className || 
         p.h2_class === className || 
         p.h3_class === className) &&
        (p.category === 'Arts group' || p.category === 'Sport group')
    );

    let historyHtml = history.length === 0 ? '<p>No participation history found.</p>' : '';

    const isDeletedClass = (className === "[DELETED]");
    const headerTitle = isDeletedClass ? `${className} Profile (DELETED)` : `${className} Profile`;
    document.getElementById('class-modal-name').textContent = headerTitle;

    history.forEach(p => {
        let role = '';
        let pts = 0;
        let studentName = '';

        if(p.h1_class === className) { role = '1st Holder'; pts = getPointsForRole(p.category, p.h1_class, 1); studentName = p.h1_name; }
        else if(p.h2_class === className) { role = '2nd Holder'; pts = getPointsForRole(p.category, p.h2_class, 2); studentName = p.h2_name; }
        else if(p.h3_class === className) { role = '3rd Holder'; pts = getPointsForRole(p.category, p.h3_class, 3); studentName = p.h3_name; }

        const nameStyle = (studentName === "[DELETED]") ? "color:#e74c3c; font-style:italic;" : "";

        historyHtml += `
            <div style="border-bottom:1px solid #eee; padding:10px 0; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div style="font-weight:bold; color:#2c3e50;">${p.name}</div>
                    <div style="font-size:0.85rem; color:#7f8c8d;">Student: ${studentName}</div>
                    <div style="font-size:0.85rem; color:#7f8c8d;">${p.date} | ${p.wing} | ${p.category || '-'}</div>
                </div>
                <div style="text-align:right;">
                    <div style="font-weight:bold; color:#27ae60;">+${pts} pts</div>
                    <div style="font-size:0.8rem; color:#7f8c8d;">${role}</div>
                </div>
            </div>
        `;
    });

    document.getElementById('class-modal-body').innerHTML = historyHtml;
    document.getElementById('class-modal').classList.add('active');
  }

  function closeClassModal() {
      document.getElementById('class-modal').classList.remove('active');
  }

  function viewDetails(id) {
    const data = JSON.parse(localStorage.getItem('programData')) || [];
    const item = data.find(i => i.id === id);
    if(!item) return;
    const esc = (txt) => txt ? txt.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : '';

    document.getElementById('modal-body').innerHTML = `
      <div style="margin-bottom: 15px; color: #7f8c8d; font-size: 0.9rem; display:flex; gap:15px; align-items:center;">
        <span><strong>Date:</strong> ${item.date}</span>
        <span><strong>Wing:</strong> ${item.wing}</span>
        <span><strong>Category:</strong> <span style="color:#3498db; font-weight:bold;">${item.category || '-'}</span></span>
      </div>
      <div style="font-size: 1.2rem; font-weight: bold; color: #2c3e50; margin-bottom: 20px;">
        ${esc(item.name)}
      </div>
     
      <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <div style="font-weight: bold; color: #333; margin-bottom: 5px;">Description:</div>
        <div style="white-space: pre-wrap;">${esc(item.description)}</div>
      </div>

      <div style="background: #e8f8f5; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #27ae60;">
        <div style="font-weight: bold; color: #27ae60; margin-bottom: 5px;">Outcomes:</div>
        <div style="white-space: pre-wrap;">${esc(item.outcomes)}</div>
      </div>

      <div style="margin-top: 20px;">
        <div style="font-weight: bold; margin-bottom: 10px;">Participants (with Class):</div>
        <div class="grid-3" style="font-size: 0.95rem; color: #555;">
          <div>1. ${esc(item.h1_name)} <span style="color:#7f8c8d; font-size:0.85rem;">(${item.h1_class})</span></div>
          <div>2. ${esc(item.h2_name)} <span style="color:#7f8c8d; font-size:0.85rem;">(${item.h2_class})</span></div>
          <div>3. ${esc(item.h3_name)} <span style="color:#7f8c8d; font-size:0.85rem;">(${item.h3_class})</span></div>
        </div>
      </div>
    `;
    document.getElementById('detail-modal').classList.add('active');
  }

  function closeModal() { document.getElementById('detail-modal').classList.remove('active'); }
  window.onclick = function(e) { 
    if (e.target == document.getElementById('detail-modal')) closeModal();
    if (e.target == document.getElementById('student-modal')) closeStudentModal();
    if (e.target == document.getElementById('class-modal')) closeClassModal();
    if (e.target == document.getElementById('meeting-modal')) closeMeetingModal();
  }

  // ===========================
  // 7. Core Dashboard Logic
  // ===========================
  function switchCoreTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
    document.querySelectorAll('.admin-tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`core-tab-${tabName}`).classList.remove('hidden');
    event.target.classList.add('active');
    if (tabName === 'meetings') renderCoreMeetings();
    if (tabName === 'programs') renderCoreReports();
    if (tabName === 'treasure') renderCoreTreasureReports();
  }

  document.getElementById('add-meeting-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const date = document.getElementById('new-meeting-date').value;
    const agenda = document.getElementById('new-meeting-agenda').value.trim();
    const title = document.getElementById('new-meeting-title').value.trim();

    if (!date || !agenda) {
      alert("Please fill Meeting Date and Agenda.");
      return;
    }

    const entry = {
      id: Date.now(),
      date: date,
      title: title,
      agenda: agenda,
      submittedBy: "Core Committee"
    };

    let meetings = JSON.parse(localStorage.getItem('meetingData')) || [];
    meetings.push(entry);
    localStorage.setItem('meetingData', JSON.stringify(meetings));

    document.getElementById('add-meeting-form').reset();
    renderCoreMeetings();
    showToast('Meeting Report Added', 'success');
  });

  function renderCoreMeetings() {
    const meetings = JSON.parse(localStorage.getItem('meetingData')) || [];
    const tbody = document.getElementById('meeting-tbody');
    const emptyMsg = document.getElementById('meeting-empty');
    tbody.innerHTML = '';

    if (meetings.length === 0) {
        emptyMsg.classList.remove('hidden');
        document.getElementById('meeting-table').classList.add('hidden');
        return;
    }

    emptyMsg.classList.add('hidden');
    document.getElementById('meeting-table').classList.remove('hidden');

    meetings.sort((a, b) => new Date(b.date) - new Date(a.date));

    meetings.forEach(item => {
      const esc = (txt) => txt ? txt.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : '';
      const displayTitle = item.title ? `<strong>${esc(item.title)}</strong>` : '-';
      const displayAgenda = item.agenda.replace(/\n/g, '<br>'); 

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.date}</td>
        <td style="min-width: 200px;">${displayAgenda}</td>
        <td>${item.submittedBy}</td>
        <td>
          <button class="btn-view" onclick="viewMeetingDetails(${item.id})">View</button>
          <button class="btn-delete" onclick="deleteMeeting(${item.id})">Del</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  function deleteMeeting(id) {
    if(!confirm("Delete this meeting report?")) return;
    let meetings = JSON.parse(localStorage.getItem('meetingData')) || [];
    meetings = meetings.filter(m => m.id !== id);
    localStorage.setItem('meetingData', JSON.stringify(meetings));
    renderCoreMeetings();
    showToast('Deleted', 'success');
  }

  function viewMeetingDetails(id) {
    const meetings = JSON.parse(localStorage.getItem('meetingData')) || [];
    const item = meetings.find(m => m.id === id);
    if(!item) return;

    const esc = (txt) => txt ? txt.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : '';

    document.getElementById('meeting-modal-body').innerHTML = `
      <div style="margin-bottom: 15px; color: #7f8c8d; font-size: 0.9rem;">
        <p><strong>Date:</strong> ${item.date}</p>
        <p><strong>Submitted By:</strong> ${item.submittedBy}</p>
        ${item.title ? `<p><strong>Subject:</strong> ${esc(item.title)}</p>` : ''}
      </div>
      <div style="background: #e8f4fd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #004085;">
        <p style="font-weight: bold; color: #004085; margin-bottom: 5px;">Agenda:</p>
        <div style="white-space: pre-wrap;">${esc(item.agenda)}</div>
      </div>
    `;
    document.getElementById('meeting-modal').classList.add('active');
  }

  function closeMeetingModal() {
      document.getElementById('meeting-modal').classList.remove('active');
  }

  function renderCoreReports() {
    const programs = JSON.parse(localStorage.getItem('programData')) || [];
    const tbody = document.getElementById('core-program-tbody');
    const emptyMsg = document.getElementById('core-program-empty');
    tbody.innerHTML = '';

    if (programs.length === 0) {
        emptyMsg.classList.remove('hidden');
        document.getElementById('core-program-table').classList.add('hidden');
        return;
    }

    emptyMsg.classList.add('hidden');
    document.getElementById('core-program-table').classList.remove('hidden');
    
    programs.sort((a, b) => new Date(b.date) - new Date(a.date));

    programs.forEach(item => {
      const h1 = item.h1_name ? `${item.h1_name}` : '-';
      const catBadge = item.category ? `<span class="cat-badge">${item.category}</span>` : '-';
      const esc = (txt) => txt ? txt.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : '';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.date}</td>
        <td><strong>${esc(item.name)}</strong></td>
        <td>${catBadge}</td>
        <td>${item.wing}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // ===========================
  // 8. Treasure/Bill Logic (Global)
  // ===========================
  
  function updateBillStatus(id, newStatus) {
      let bills = JSON.parse(localStorage.getItem('billData')) || [];
      const bill = bills.find(b => b.id === id);
      if(bill) {
          bill.status = newStatus;
          localStorage.setItem('billData', JSON.stringify(bills));
          
          // Refresh views depending on who is logged in
          if(currentUser.role === 'admin') renderTreasureReports();
          if(currentUser.role === 'treasury') renderTreasuryDashboard();
          if(currentUser.role === 'core') renderCoreTreasureReports();
          
          showToast(`Bill marked as ${newStatus}`, 'success');
      }
  }

  function deleteBill(id) {
      if(!confirm("Delete this bill?")) return;
      let data = JSON.parse(localStorage.getItem('billData')) || [];
      data = data.filter(i => i.id !== id);
      localStorage.setItem('billData', JSON.stringify(data));
      
      if(currentUser.role === 'admin') renderTreasureReports();
      if(currentUser.role === 'treasury') renderTreasuryDashboard();
      if(currentUser.role === 'core') renderCoreTreasureReports();
      
      showToast('Bill Deleted', 'success');
  }

  function viewBillDetails(id) {
      const bills = JSON.parse(localStorage.getItem('billData')) || [];
      const item = bills.find(b => b.id === id);
      if(!item) return;
      const esc = (txt) => txt ? txt.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : '';
      
      let statusColor = '#f39c12';
      if(item.status === 'Approved') statusColor = '#27ae60';
      if(item.status === 'Rejected') statusColor = '#c0392b';

      // Show different buttons if viewing as Treasury Secretary vs Admin vs Core
      let actionButtons = '';
      if(currentUser && currentUser.role === 'treasury' && item.status === 'Pending') {
          actionButtons = `
            <div style="margin-top:20px; border-top:1px solid #eee; padding-top:15px; text-align:right;">
                <button class="btn-reject" onclick="closeModal(); updateBillStatus(${item.id}, 'Rejected')" style="padding:10px 20px;">Reject</button>
                <button class="btn-approve" onclick="closeModal(); updateBillStatus(${item.id}, 'Approved')" style="padding:10px 20px;">Approve & Sign</button>
            </div>
          `;
      }

      document.getElementById('modal-body').innerHTML = `
        <h2 style="color:#d35400;">Official Bill Request</h2>
        <div style="margin-bottom: 15px; color: #7f8c8d; font-size: 0.9rem; display:flex; gap:15px; align-items:center;">
          <span><strong>Date:</strong> ${item.date}</span>
          <span><strong>Wing:</strong> ${item.wing}</span>
          <span><strong>Status:</strong> <strong style="color:${statusColor}">${item.status}</strong></span>
        </div>
        <div style="font-size: 1.2rem; font-weight: bold; color: #2c3e50; margin-bottom: 20px;">
          ${esc(item.subject)}
        </div>
        <div style="background: #f1c40f; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
          <div style="font-weight: bold; margin-bottom: 5px;">Amount Requested:</div>
          <div style="font-size: 1.8rem; font-weight:bold;">‚Çπ ${esc(item.amount)}</div>
        </div>
        <div style="margin-bottom: 15px;">
          <div style="font-weight: bold; color: #555; margin-bottom: 5px;">Category:</div>
          <div>${item.category}</div>
        </div>
        <div style="margin-bottom: 15px;">
          <div style="font-weight: bold; color: #555; margin-bottom: 5px;">Description:</div>
          <div style="white-space: pre-wrap;">${esc(item.description)}</div>
        </div>
        <div style="margin-bottom: 15px;">
          <div style="font-weight: bold; color: #555; margin-bottom: 5px;">Receipt/Attachment:</div>
          <div style="color:#3498db;">${item.receipt !== "No Receipt" ? 'üìé ' + esc(item.receipt) : 'No file uploaded'}</div>
        </div>
        ${actionButtons}
      `;
      document.getElementById('detail-modal').classList.add('active');
  }

  // --- Admin Treasure View Logic ---
  function renderTreasureReports() {
      const bills = JSON.parse(localStorage.getItem('billData')) || [];
      const tbody = document.getElementById('treasure-tbody');
      const emptyMsg = document.getElementById('treasure-empty');
      const table = document.getElementById('treasure-table');

      const approvedBills = bills.filter(b => b.status === 'Approved');
      const total = approvedBills.reduce((sum, bill) => sum + Number(bill.amount), 0);
      const totalDisplay = new Intl.NumberFormat('en-IN').format(total);
      document.getElementById('grand-total-display').textContent = `‚Çπ ${totalDisplay}`;

      tbody.innerHTML = '';
      if (bills.length === 0) {
          emptyMsg.classList.remove('hidden');
          table.classList.add('hidden');
          return;
      }

      emptyMsg.classList.add('hidden');
      table.classList.remove('hidden');

      bills.sort((a, b) => new Date(b.date) - new Date(a.date));
      bills.forEach(bill => {
          const esc = (txt) => txt ? txt.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : '';
          
          let statusBadgeClass = '';
          if(bill.status === 'Pending') statusBadgeClass = 'status-pending';
          else if(bill.status === 'Approved') statusBadgeClass = 'status-approved';
          else if(bill.status === 'Rejected') statusBadgeClass = 'status-rejected';

          let actionButtons = '';
          if(bill.status === 'Pending') {
              actionButtons = `
                <button class="btn-approve" onclick="updateBillStatus(${bill.id}, 'Approved')">‚úî</button>
                <button class="btn-reject" onclick="updateBillStatus(${bill.id}, 'Rejected')">‚úñ</button>
              `;
          } else {
              actionButtons = `<span style="color:#95a5a6; font-size:0.8rem;">Processed</span>`;
          }

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${bill.date}</td>
            <td>${bill.wing}</td>
            <td>${esc(bill.subject)}</td>
            <td>${bill.category}</td>
            <td class="amount-highlight">‚Çπ ${esc(bill.amount)}</td>
            <td><span class="status-badge ${statusBadgeClass}">${bill.status}</span></td>
            <td>
              <button class="btn-view" onclick="viewBillDetails(${bill.id})">View</button>
              ${actionButtons}
              <button class="btn-delete" onclick="deleteBill(${bill.id})">Del</button>
            </td>`;
          tbody.appendChild(tr);
      });
  }

  // --- Core Treasure View Logic ---
  function submitCoreBill() {
    // 1. Get Values
    const date = document.getElementById('Core_Bill_Date').value;
    const amount = document.getElementById('Core_Bill_Amount').value;
    const wing = document.getElementById('Core_Bill_Wing').value.trim();
    const category = document.getElementById('Core_Bill_Category').value;
    const subject = document.getElementById('Core_Bill_Subject').value.trim();
    const reason = document.getElementById('Core_Bill_Reason').value.trim();
    const receiptInput = document.getElementById('Core_Bill_Receipt');
  
    const errorBox = document.getElementById('core-bill-error');
    const successBox = document.getElementById('core-bill-success');

    // 2. Validation
    if (!date || !amount || !wing || !category || !subject || !reason) {
        errorBox.textContent = "Please fill in all required fields.";
        errorBox.style.display = 'block';
        successBox.style.display = 'none';
        return;
    }

    // 3. Create Bill Object (Auto-approved for Core authority)
    const newBill = {
      id: Date.now(),
      date: date,
      wing: wing,
      amount: amount,
      category: category,
      subject: subject,
      description: reason, // Mapping reason to description
      receipt: receiptInput.files[0] ? receiptInput.files[0].name : "No Receipt",
      status: 'Approved' // Core entries are considered Official/Audited by default
    };

    // 4. Save to LocalStorage
    let bills = JSON.parse(localStorage.getItem('billData')) || [];
    bills.push(newBill);
    localStorage.setItem('billData', JSON.stringify(bills));

    // 5. Feedback & Cleanup
    showToast('Official Entry Added to Ledger', 'success');
  
    // Clear form fields
    document.getElementById('Core_Bill_Date').value = "";
    document.getElementById('Core_Bill_Amount').value = "";
    document.getElementById('Core_Bill_Wing').value = "Core Committee"; 
    document.getElementById('Core_Bill_Category').value = "";
    document.getElementById('Core_Bill_Subject').value = "";
    document.getElementById('Core_Bill_Reason').value = "";
    document.getElementById('Core_Bill_Receipt').value = "";
  
    errorBox.style.display = 'none';
    successBox.style.display = 'none';

    // Refresh table
    renderCoreTreasureReports();
}

  function renderCoreTreasureReports() {
      const bills = JSON.parse(localStorage.getItem('billData')) || [];
      const tbody = document.getElementById('core-treasure-tbody');
      const emptyMsg = document.getElementById('core-treasure-empty');
      const table = document.getElementById('core-treasure-table');

      const approvedBills = bills.filter(b => b.status === 'Approved');
      const total = approvedBills.reduce((sum, bill) => sum + Number(bill.amount), 0);
      const totalDisplay = new Intl.NumberFormat('en-IN').format(total);
      document.getElementById('core-grand-total-display').textContent = `‚Çπ ${totalDisplay}`;

      tbody.innerHTML = '';
      if (bills.length === 0) {
          emptyMsg.classList.remove('hidden');
          table.classList.add('hidden');
          return;
      }

      emptyMsg.classList.add('hidden');
      table.classList.remove('hidden');

      // Sort by date (Newest first)
      bills.sort((a, b) => new Date(b.date) - new Date(a.date));
  
      bills.forEach(bill => {
          const esc = (txt) => txt ? txt.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : '';
          
          let statusBadgeClass = '';
          if(bill.status === 'Pending') statusBadgeClass = 'status-pending';
          else if(bill.status === 'Approved') statusBadgeClass = 'status-approved';
          else if(bill.status === 'Rejected') statusBadgeClass = 'status-rejected';

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${bill.date}</td>
            <td>${bill.wing}</td>
            <td><strong>${esc(bill.subject)}</strong></td>
            <td>${bill.category}</td>
            <td><small style="color:#7f8c8d;">${esc(bill.description)}</small></td>
            <td class="amount-highlight">‚Çπ ${esc(bill.amount)}</td>
            <td>${bill.receipt !== "No Receipt" ? 'üìé '+esc(bill.receipt) : '-'}</td>
            <td>
               <span class="status-badge ${statusBadgeClass}">${bill.status}</span>
               <button class="btn-delete" onclick="deleteCoreBill(${bill.id})">Del</button>
            </td>
          `;
          tbody.appendChild(tr);
      });
  }

  function deleteCoreBill(id) {
    if(!confirm("Are you sure you want to remove this official entry from ledger?")) return;
    let data = JSON.parse(localStorage.getItem('billData')) || [];
    data = data.filter(i => i.id !== id);
    localStorage.setItem('billData', JSON.stringify(data));
    
    // Refresh view
    renderCoreTreasureReports();
    showToast('Entry Deleted', 'success');
}

  // ===========================
  // 9. TREASURY COMMITTEE LOGIC (NEW)
  // ===========================
  
  function switchTreasuryTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
    document.querySelectorAll('.admin-tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`tr-tab-${tabName}`).classList.remove('hidden');
    event.target.classList.add('active');
    renderTreasuryDashboard();
  }

  // NEW: Submit Direct Bill (Secretary)
  function submitSecretaryBill() {
    // 1. Get Values
    const date = document.getElementById('Sec_Bill_Date').value;
    const amount = document.getElementById('Sec_Bill_Amount').value;
    const wing = document.getElementById('Sec_Bill_Wing').value.trim();
    const category = document.getElementById('Sec_Bill_Category').value;
    const subject = document.getElementById('Sec_Bill_Subject').value.trim();
    const reason = document.getElementById('Sec_Bill_Reason').value.trim();
    const errorBox = document.getElementById('sec-bill-error');

    // 2. Validation
    if (!date || !amount || !wing || !category || !subject || !reason) {
        errorBox.textContent = "Please fill in all required fields.";
        errorBox.style.display = 'block';
        return;
    }

    // 3. Create Bill Object (Auto-approved for Secretary authority)
    const newBill = {
      id: Date.now(),
      date: date,
      wing: wing,
      amount: amount,
      category: category,
      subject: subject,
      description: reason, // Mapping reason to description
      receipt: "No Receipt (Cash Entry)",
      status: 'Approved' // Secretary entries are considered Official/Audited by default
    };

    // 4. Save to LocalStorage
    let bills = JSON.parse(localStorage.getItem('billData')) || [];
    bills.push(newBill);
    localStorage.setItem('billData', JSON.stringify(bills));

    // 5. Feedback & Cleanup
    showToast('Official Cash Entry Added', 'success');
  
    // Clear the form fields
    document.getElementById('Sec_Bill_Date').value = "";
    document.getElementById('Sec_Bill_Amount').value = "";
    document.getElementById('Sec_Bill_Wing').value = "Treasury Committee (Cash)"; 
    document.getElementById('Sec_Bill_Category').value = "";
    document.getElementById('Sec_Bill_Subject').value = "";
    document.getElementById('Sec_Bill_Reason').value = "";
    
    errorBox.style.display = 'none';

    // Refresh the dashboard to show new entry in ledger/overview
    renderTreasuryDashboard();
}

  function renderTreasuryDashboard() {
      const bills = JSON.parse(localStorage.getItem('billData')) || [];
      
      // --- UPDATE OVERVIEW STATS ---
      const pendingCount = bills.filter(b => b.status === 'Pending').length;
      const pendingTotal = bills.filter(b => b.status === 'Pending').reduce((sum, b) => sum + Number(b.amount), 0);
      const approvedTotal = bills.filter(b => b.status === 'Approved').reduce((sum, b) => sum + Number(b.amount), 0);
      const rejectedTotal = bills.filter(b => b.status === 'Rejected').reduce((sum, b) => sum + Number(b.amount), 0);

      document.getElementById('sec-pending-count').textContent = pendingCount;
      document.getElementById('sec-pending-total').textContent = '‚Çπ ' + new Intl.NumberFormat('en-IN').format(pendingTotal);
      document.getElementById('sec-grand-total').textContent = '‚Çπ ' + new Intl.NumberFormat('en-IN').format(approvedTotal);
      document.getElementById('sec-rejected-total').textContent = '‚Çπ ' + new Intl.NumberFormat('en-IN').format(rejectedTotal);

      // --- RENDER INCOMING (Pending) ---
      const tbodyInc = document.getElementById('tr-incoming-tbody');
      tbodyInc.innerHTML = '';
      const pendingBills = bills.filter(b => b.status === 'Pending').sort((a,b) => new Date(a.date) - new Date(b.date));
      
      if(pendingBills.length === 0) {
          document.getElementById('tr-incoming-empty').classList.remove('hidden');
          document.getElementById('tr-incoming-table').classList.add('hidden');
      } else {
          document.getElementById('tr-incoming-empty').classList.add('hidden');
          document.getElementById('tr-incoming-table').classList.remove('hidden');
          
          pendingBills.forEach(bill => {
             const tr = document.createElement('tr');
             tr.innerHTML = `
                <td>${bill.date}</td>
                <td>${bill.wing}</td>
                <td>${bill.subject}</td>
                <td>${bill.category}</td>
                <td style="font-weight:bold; color:#d35400;">‚Çπ ${bill.amount}</td>
                <td>${bill.receipt === "No Receipt" ? '<span style="color:#95a5a6">-</span>' : '<span style="color:#27ae60">‚úî Uploaded</span>'}</td>
                <td>
                   <button class="btn-view" onclick="viewBillDetails(${bill.id})">Review</button>
                   <button class="btn-approve" onclick="updateBillStatus(${bill.id}, 'Approved')" title="Approve">‚úî</button>
                   <button class="btn-reject" onclick="updateBillStatus(${bill.id}, 'Rejected')" title="Reject">‚úñ</button>
                </td>
             `;
             tbodyInc.appendChild(tr);
          });
      }

      // --- RENDER APPROVED LEDGER ---
      const tbodyApp = document.getElementById('tr-approved-tbody');
      tbodyApp.innerHTML = '';
      const approvedBillsList = bills.filter(b => b.status === 'Approved').sort((a,b) => new Date(a.date) - new Date(b.date));
      
      if(approvedBillsList.length === 0) {
          document.getElementById('tr-approved-empty').classList.remove('hidden');
          document.getElementById('tr-approved-table').classList.add('hidden');
      } else {
          document.getElementById('tr-approved-empty').classList.add('hidden');
          document.getElementById('tr-approved-table').classList.remove('hidden');

          approvedBillsList.forEach(bill => {
             const tr = document.createElement('tr');
             tr.innerHTML = `
                <td>${bill.date}</td>
                <td>${bill.wing}</td>
                <td>${bill.subject}</td>
                <td>${bill.category}</td>
                <td style="font-weight:bold; color:#27ae60;">‚Çπ ${bill.amount}</td>
                <td>${bill.receipt}</td>
                <td>
                   <button class="btn-view" onclick="viewBillDetails(${bill.id})">View</button>
                   <button class="btn-delete" onclick="deleteBill(${bill.id})">Archive</button>
                </td>
             `;
             tbodyApp.appendChild(tr);
          });
      }

      // --- RENDER REJECTED ---
      const tbodyRej = document.getElementById('tr-rejected-tbody');
      tbodyRej.innerHTML = '';
      const rejectedBillsList = bills.filter(b => b.status === 'Rejected').sort((a,b) => new Date(a.date) - new Date(a.date));
      
      if(rejectedBillsList.length === 0) {
          document.getElementById('tr-rejected-empty').classList.remove('hidden');
          document.getElementById('tr-rejected-table').classList.add('hidden');
      } else {
          document.getElementById('tr-rejected-empty').classList.add('hidden');
          document.getElementById('tr-rejected-table').classList.remove('hidden');

          rejectedBillsList.forEach(bill => {
             const tr = document.createElement('tr');
             tr.innerHTML = `
                <td>${bill.date}</td>
                <td>${bill.wing}</td>
                <td>${bill.subject}</td>
                <td>${bill.category}</td>
                <td style="color:#c0392b;">‚Çπ ${bill.amount}</td>
                <td><span style="font-weight:bold; color:#c0392b;">${bill.status}</span></td>
                <td>
                   <button class="btn-view" onclick="viewBillDetails(${bill.id})">View</button>
                   <button class="btn-delete" onclick="deleteBill(${bill.id})">Del</button>
                </td>
             `;
             tbodyRej.appendChild(tr);
          });
      }
  }

  function showToast(msg, type='success') {
    const t = document.createElement('div'); t.className = 'toast';
    t.style.borderLeft = `5px solid ${type=='success'?'#27ae60':'#c0392b'}`;
    t.textContent = msg; document.getElementById('toast-container').appendChild(t);
    setTimeout(() => t.remove(), 3000);
  }
</script>

<script></script></body></html>